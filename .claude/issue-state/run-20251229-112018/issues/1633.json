{
  "number": 1633,
  "title": "refactor(quic): inline single-use helper in SocketQUICWire.c",
  "body": "## Summary\n\nInline single-use static helper function `bits_needed` to reduce indirection and improve code locality.\n\n**Category**: Refactoring\n**Severity**: LOW\n**Pattern**: `SINGLE_USE_FUNCTION`\n**Files Affected**: 1\n\n## Affected Locations\n\n| File | Lines | Function | Usage |\n|------|-------|----------|-------|\n| `src/quic/SocketQUICWire.c` | 44-57 | `bits_needed` | Called once at line 97 |\n\n## Problem\n\nThe `bits_needed` function is a small helper (12 lines) that calculates `floor(log2(x)) + 1`. It is only called once in the entire codebase, from `SocketQUICWire_pn_length` at line 97.\n\n**Current code:**\n```c\n/* Helper function (lines 44-57) */\nstatic unsigned\nbits_needed (uint64_t x)\n{\n  unsigned bits = 0;\n\n  if (x == 0)\n    return 1;\n\n  while (x > 0)\n    {\n      bits++;\n      x >>= 1;\n    }\n\n  return bits;\n}\n\n/* Single call site (line 97) */\nmin_bits = bits_needed (num_unacked);\n```\n\nSingle-use helpers add unnecessary indirection without providing reusability benefits. Inlining improves code locality, making the algorithm easier to understand in context.\n\n## Recommended Fix\n\nInline the bit calculation directly into `SocketQUICWire_pn_length`:\n\n```c\n/* In SocketQUICWire_pn_length around line 96-97 */\n\n/* Calculate floor(log2(num_unacked)) + 1 */\nif (num_unacked == 0)\n  {\n    min_bits = 1;\n  }\nelse\n  {\n    min_bits = 0;\n    uint64_t tmp = num_unacked;\n    while (tmp > 0)\n      {\n        min_bits++;\n        tmp >>= 1;\n      }\n  }\n```\n\n**Alternative**: If bit counting is a common pattern, consider using compiler intrinsics like `__builtin_clzll` (count leading zeros) for better performance:\n\n```c\n/* Modern approach using intrinsics */\nmin_bits = (num_unacked == 0) ? 1 : (64 - __builtin_clzll(num_unacked));\n```\n\n## Checklist\n\n- [ ] Inline `bits_needed` into `SocketQUICWire_pn_length` at line 97\n- [ ] Remove the `bits_needed` function definition (lines 44-57)\n- [ ] Remove the function comment (lines 39-42)\n- [ ] Consider using `__builtin_clzll` for performance (optional)\n- [ ] Run tests: `cd build && ./test_quic_wire`\n- [ ] Verify no regressions with sanitizers\n\n## References\n\n- RFC 9000 Appendix A.2 - Packet Number Encoding algorithm\n- GCC intrinsics: `__builtin_clzll` (count leading zeros, long long)\n\n---\n*Generated by /pipeline code analysis*",
  "labels": [
    "enhancement",
    "good first issue",
    "quic"
  ],
  "state": "OPEN",
  "dependencies": []
}