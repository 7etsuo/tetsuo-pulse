{
  "number": 1630,
  "title": "refactor(quic): inline single-use helper functions in SocketQUICConnectionID-pool.c",
  "body": "## Summary\n\nThree small static helper functions in `src/quic/SocketQUICConnectionID-pool.c` are each called only once, adding unnecessary indirection. These should be inlined into their callers to improve code locality and reduce function call overhead.\n\n**Category**: Refactoring\n**Severity**: LOW\n**Pattern**: Single-use functions that should be inlined\n**Files Affected**: 1\n\n## Affected Functions\n\n| Function | Lines | Call Count | Caller Location | Code Size |\n|----------|-------|------------|-----------------|-----------|\n| `list_append` | 158-170 (13 lines) | 1 | `SocketQUICConnectionIDPool_add_with_sequence:382` | Trivial list operation |\n| `hash_insert` | 196-204 (9 lines) | 1 | `SocketQUICConnectionIDPool_add_with_sequence:380` | Simple hash table insert |\n| `sequence_hash_insert` | 233-240 (8 lines) | 1 | `SocketQUICConnectionIDPool_add_with_sequence:381` | Simple sequence hash insert |\n\n## Problem\n\nThese functions are small, trivial operations that are only called once in the entire codebase:\n\n1. **`list_append`** - Appends an entry to the doubly-linked list. This is straightforward pointer manipulation (6 lines of actual code) called only from line 382.\n\n2. **`hash_insert`** - Inserts an entry into the CID hash table. This is a simple hash-and-insert operation (4 lines of actual code) called only from line 380.\n\n3. **`sequence_hash_insert`** - Inserts an entry into the sequence hash table. Nearly identical to `hash_insert` but for the sequence table (4 lines of actual code) called only from line 381.\n\nThe abstraction adds no value:\n- **Not reused** - Each function has exactly one call site\n- **No complexity reduction** - The operations are simple enough to read inline\n- **Hurts locality** - Reader must jump to function definition to understand the operation\n- **Function call overhead** - Minimal but unnecessary\n\n**Note**: The removal counterparts (`list_remove`, `hash_remove`, `sequence_hash_remove`) are used in multiple places and should remain as functions.\n\n## Recommended Fix\n\nInline these functions into their single call site in `SocketQUICConnectionIDPool_add_with_sequence` (around line 379-382):\n\n### Before (lines 379-382)\n```c\n/* Insert into hash tables and list */\nhash_insert (pool, entry);\nsequence_hash_insert (pool, entry);\nlist_append (pool, entry);\n```\n\n### After\n```c\n/* Insert into hash tables and list */\n\n/* Hash insert by CID bytes */\nunsigned idx = hash_cid_bytes (entry->cid.data, entry->cid.len, pool->hash_seed);\nentry->hash_next = pool->hash_table[idx];\npool->hash_table[idx] = entry;\n\n/* Hash insert by sequence number */\nunsigned seq_idx = hash_sequence (entry->cid.sequence, pool->hash_seed);\nentry->seq_hash_next = pool->sequence_table[seq_idx];\npool->sequence_table[seq_idx] = entry;\n\n/* Append to doubly-linked list */\nentry->list_prev = pool->list_tail;\nentry->list_next = NULL;\nif (pool->list_tail)\n  pool->list_tail->list_next = entry;\nelse\n  pool->list_head = entry;\npool->list_tail = entry;\n```\n\n**Note**: Variable `idx` is already declared at line 355, so can be reused. Declare `seq_idx` for the sequence hash index.\n\n## Benefits\n\n1. **Improved readability** - Operations visible at their single use site\n2. **Better code locality** - No need to jump to function definitions\n3. **Reduced indirection** - Fewer function calls to trace\n4. **Consistency** - Matches pattern of other single-use operations in the codebase\n\n## Checklist\n\n- [ ] Remove `list_append` function (lines 158-170)\n- [ ] Remove `hash_insert` function (lines 196-204)\n- [ ] Remove `sequence_hash_insert` function (lines 233-240)\n- [ ] Inline operations into `SocketQUICConnectionIDPool_add_with_sequence` at lines 380-382\n- [ ] Verify no other call sites exist (grep/search)\n- [ ] Run tests: `cd build && ctest -R quic -j$(nproc) --output-on-failure`\n- [ ] Verify no regressions with sanitizers: `ASAN_OPTIONS=detect_leaks=1:abort_on_error=1 ctest -R quic -j$(nproc)`\n\n## References\n\n- Similar pattern used in `SocketQUICConnectionIDPool_add_with_sequence` where operations are already inlined (e.g., entry creation, validation)\n- Counterpart removal functions (`list_remove`, `hash_remove`, `sequence_hash_remove`) are correctly kept as functions due to multiple call sites\n\n---\n*Generated by /pipeline code analysis - Single-Use Functions detection*",
  "labels": [
    "enhancement",
    "good first issue",
    "quic"
  ],
  "state": "OPEN",
  "dependencies": []
}