{
  "number": 1634,
  "title": "refactor(quic): flatten nested if statements in SocketQUICStream-state.c",
  "body": "## Summary\n\nReduce nesting depth in state transition table lookups by inverting match conditions and using early continue.\n\n**Category**: Refactoring\n**Severity**: MEDIUM\n**Pattern**: `NESTED_IF_DEPTH_3`\n**Files Affected**: 1\n\n## Affected Locations\n\n| File | Lines | Function | Context |\n|------|-------|----------|---------|\n| `src/quic/SocketQUICStream-state.c` | 218-238 | `SocketQUICStream_transition_send` | Send-side state transition loop |\n| `src/quic/SocketQUICStream-state.c` | 314-332 | `SocketQUICStream_transition_recv` | Receive-side state transition loop |\n\n## Problem\n\nBoth state transition functions use 3-level deep nested if statements inside their table lookup loops:\n\n**Send-side (lines 218-238)**:\n```c\n/* Search transition table for valid transition */\nfor (size_t i = 0; i < SEND_TRANSITIONS_COUNT; i++)\n  {\n    if (send_transitions[i].from_state == current\n        && send_transitions[i].event == event)\n      {\n        /* Valid transition found - execute it */\n        stream->send_state = send_transitions[i].to_state;\n\n        /* Update flags based on transition */\n        if (event == QUIC_STREAM_EVENT_SEND_FIN)\n          stream->fin_sent = 1;\n        else if (event == QUIC_STREAM_EVENT_SEND_RESET ||\n                 event == QUIC_STREAM_EVENT_RECV_STOP_SENDING)\n          stream->reset_sent = 1;\n\n        /* Update legacy combined state for backwards compatibility */\n        update_legacy_state_send (stream);\n\n        return QUIC_STREAM_OK;\n      }\n  }\n```\n\n**Receive-side (lines 314-332)**: Identical pattern in `SocketQUICStream_transition_recv`\n\nThe nesting depth makes the control flow slightly harder to follow and increases the visual indentation level unnecessarily.\n\n## Recommended Fix\n\nInvert the match condition and use `continue` to skip non-matching entries early:\n\n```c\n/* Search transition table for valid transition */\nfor (size_t i = 0; i < SEND_TRANSITIONS_COUNT; i++)\n  {\n    /* Skip non-matching transitions */\n    if (send_transitions[i].from_state != current ||\n        send_transitions[i].event != event)\n      continue;\n\n    /* Valid transition found - execute it */\n    stream->send_state = send_transitions[i].to_state;\n\n    /* Update flags based on transition */\n    if (event == QUIC_STREAM_EVENT_SEND_FIN)\n      stream->fin_sent = 1;\n    else if (event == QUIC_STREAM_EVENT_SEND_RESET ||\n             event == QUIC_STREAM_EVENT_RECV_STOP_SENDING)\n      stream->reset_sent = 1;\n\n    /* Update legacy combined state for backwards compatibility */\n    update_legacy_state_send (stream);\n\n    return QUIC_STREAM_OK;\n  }\n```\n\nApply the same pattern to `SocketQUICStream_transition_recv` (lines 314-332).\n\n## Benefits\n\n- **Reduced nesting**: Main logic moves from level 3 to level 2\n- **Early exit pattern**: More idiomatic C control flow\n- **No behavior change**: Semantically identical transformation\n- **Improved readability**: Less horizontal indentation\n\n## Checklist\n\n- [ ] Flatten loop in `SocketQUICStream_transition_send` (lines 218-238)\n- [ ] Flatten loop in `SocketQUICStream_transition_recv` (lines 314-332)\n- [ ] Run unit tests: `cd build && ./test_quic_stream_state`\n- [ ] Verify with sanitizers: `ASAN_OPTIONS=detect_leaks=1 ./test_quic_stream_state`\n- [ ] Ensure no behavior change\n\n## References\n\n- RFC 9000 Section 3.1 (Send-side state machine)\n- RFC 9000 Section 3.2 (Receive-side state machine)\n- Related: Table-driven state machine pattern in this file\n\n---\n*Generated by /pipeline code analysis*",
  "labels": [
    "enhancement",
    "quic"
  ],
  "state": "OPEN",
  "dependencies": []
}