{
  "number": 1631,
  "title": "refactor(quic): inline single-use helper functions in SocketQUICAddrValidation.c",
  "body": "## Summary\n\nThree small static helper functions in `SocketQUICAddrValidation_validate_token()` are called exactly once and add unnecessary indirection. Inlining them would improve code locality and readability.\n\n**Category**: Refactoring\n**Severity**: LOW\n**Pattern**: `SINGLE_USE_FUNCTION`\n**Files Affected**: 1\n\n## Affected Locations\n\n| File | Lines | Function | Size | Issue |\n|------|-------|----------|------|-------|\n| `src/quic/SocketQUICAddrValidation.c` | 171-185 | `validate_token_format` | 12 lines | Simple null/size check, called once at line 343 |\n| `src/quic/SocketQUICAddrValidation.c` | 193-207 | `check_token_expiration` | 10 lines | Time comparison, called once at line 353 |\n| `src/quic/SocketQUICAddrValidation.c` | 216-229 | `verify_token_address` | 14 lines | Address comparison, called once at line 360 |\n\n## Problem\n\nThese three functions are only called from `SocketQUICAddrValidation_validate_token()` (lines 327-374) and create unnecessary abstraction layers:\n\n1. **`validate_token_format`** - Checks if token is NULL and has the correct size. This is a trivial 2-condition check that doesn't benefit from being a separate function.\n\n2. **`check_token_expiration`** - Compares current time against token timestamp. The logic is straightforward and would be clearer inline.\n\n3. **`verify_token_address`** - Calls `hash_address()` and compares the hash. While slightly more complex, it's still simple enough to inline without hurting readability.\n\nThe current structure forces readers to jump between functions to understand the validation flow, when the logic would be clearer as a sequential series of checks in the main function.\n\n**Note**: The function `compute_and_verify_token_hmac()` (lines 240-272) is also called once, but it's sufficiently complex (20+ lines with TRY/EXCEPT) that keeping it separate is justified.\n\n## Recommended Fix\n\nInline the three functions directly into `SocketQUICAddrValidation_validate_token()`:\n\n```c\nSocketQUICAddrValidation_Result\nSocketQUICAddrValidation_validate_token (const uint8_t *token,\n                                          size_t token_len,\n                                          const struct sockaddr *addr,\n                                          const uint8_t *secret)\n{\n  volatile SocketQUICAddrValidation_Result result;\n  uint64_t token_timestamp;\n  uint8_t addr_hash[QUIC_TOKEN_ADDR_HASH_SIZE];\n\n  /* Validate inputs */\n  if (!addr || !secret)\n    {\n      return QUIC_ADDR_VALIDATION_ERROR_NULL;\n    }\n\n  /* Validate token format (inlined from validate_token_format) */\n  if (!token)\n    {\n      return QUIC_ADDR_VALIDATION_ERROR_NULL;\n    }\n  if (token_len != QUIC_ADDR_VALIDATION_TOKEN_SIZE)\n    {\n      return QUIC_ADDR_VALIDATION_ERROR_INVALID;\n    }\n\n  /* Extract timestamp */\n  token_timestamp = socket_util_unpack_be64 (token);\n\n  /* Check token expiration (inlined from check_token_expiration) */\n  uint64_t current_time = (uint64_t)Socket_get_monotonic_ms ();\n  if (current_time > token_timestamp\n      && (current_time - token_timestamp)\n             > (QUIC_ADDR_VALIDATION_TOKEN_LIFETIME * SOCKET_MS_PER_SECOND))\n    {\n      return QUIC_ADDR_VALIDATION_ERROR_EXPIRED;\n    }\n\n  /* Verify address match (inlined from verify_token_address) */\n  hash_address (addr, addr_hash);\n  if (SocketCrypto_secure_compare (token + QUIC_TOKEN_TIMESTAMP_SIZE, addr_hash,\n                                    QUIC_TOKEN_ADDR_HASH_SIZE) != 0)\n    {\n      return QUIC_ADDR_VALIDATION_ERROR_INVALID;\n    }\n\n  /* Verify HMAC (keep as separate function - complex enough to justify) */\n  result = compute_and_verify_token_hmac (token, token_timestamp, addr, secret);\n  if (result != QUIC_ADDR_VALIDATION_OK)\n    {\n      return result;\n    }\n\n  return QUIC_ADDR_VALIDATION_OK;\n}\n```\n\n## Benefits\n\n1. **Improved code locality** - All validation logic in one place, easier to understand the complete validation flow\n2. **Reduced indirection** - No function call overhead for trivial checks\n3. **Better readability** - Sequential validation steps are clearer when inlined\n4. **Maintains clarity** - The complex HMAC verification remains separate where it belongs\n\n## Checklist\n\n- [ ] Inline `validate_token_format` into `SocketQUICAddrValidation_validate_token`\n- [ ] Inline `check_token_expiration` into `SocketQUICAddrValidation_validate_token`\n- [ ] Inline `verify_token_address` into `SocketQUICAddrValidation_validate_token`\n- [ ] Remove now-unused static function declarations\n- [ ] Run tests with sanitizers: `cmake -B build -DENABLE_SANITIZERS=ON && cmake --build build -j$(nproc) && cd build && ASAN_OPTIONS=detect_leaks=1:abort_on_error=1 ctest -j$(nproc) --output-on-failure`\n- [ ] Verify no regressions in QUIC address validation tests\n\n## References\n\n- RFC 9000 Section 8: Address Validation (context for this code)\n- Codebase pattern: Keep `compute_and_verify_token_hmac` separate due to complexity\n- Similar refactoring completed in other modules (Arena, SocketPool)\n\n---\n*Generated by /pipeline code analysis*",
  "labels": [
    "enhancement",
    "good first issue",
    "quic"
  ],
  "state": "OPEN",
  "dependencies": []
}