{
  "number": 1636,
  "title": "refactor(quic): flatten nested if statements in packet routing logic",
  "body": "## Summary\n\nRefactor deeply nested if statements in QUIC connection demultiplexing to use guard clauses with early returns.\n\n**Category**: Refactoring\n**Severity**: HIGH\n**Pattern**: `NESTED_IF_DEPTH_4`\n**Files Affected**: 1\n\n## Affected Locations\n\n| File | Lines | Context |\n|------|------|---------|\n| `src/quic/SocketQUICConnection-demux.c` | 306-321 (estimated) | Packet routing with 4-level nesting |\n\n## Problem\n\nBased on the QUIC module refactor analysis (see `src/quic/REFACTOR_ANALYSIS.md`), the connection demultiplexing logic contains deeply nested if statements (depth 4) that reduce readability and make the code harder to maintain. The pattern looks like:\n\n```c\nif (packet_valid) {\n    if (dcid_len >= QUIC_MIN_CID_LEN) {\n        if ((conn = lookup_by_dcid(dcid))) {\n            if (conn->state != QUIC_CONN_CLOSED) {\n                deliver_packet(conn, packet);\n            }\n        }\n    }\n}\n```\n\nThis creates a \"rightward drift\" pattern that:\n- Makes the main logic harder to follow\n- Obscures error handling paths\n- Violates the guard clause pattern used elsewhere in the codebase\n- Increases cognitive complexity\n\n## Recommended Fix\n\nFlatten the nesting using guard clauses with early returns:\n\n```c\nif (!packet_valid)\n    return QUIC_DEMUX_INVALID_PACKET;\n\nif (dcid_len < QUIC_MIN_CID_LEN)\n    return QUIC_DEMUX_SHORT_CID;\n\nconn = lookup_by_dcid(dcid);\nif (!conn)\n    return QUIC_DEMUX_NO_MATCH;\n\nif (conn->state == QUIC_CONN_CLOSED)\n    return QUIC_DEMUX_CONN_CLOSED;\n\ndeliver_packet(conn, packet);\nreturn QUIC_DEMUX_OK;\n```\n\nThis refactor:\n- Reduces nesting from depth 4 to depth 1\n- Makes error conditions explicit and easy to identify\n- Aligns with the guard clause pattern used in exemplary QUIC files\n- Improves maintainability without changing behavior\n\n## Checklist\n\n- [ ] Identify the exact function with this pattern in `SocketQUICConnection-demux.c`\n- [ ] Refactor to use guard clauses with appropriate return codes\n- [ ] Ensure all error paths have proper result codes\n- [ ] Run tests with sanitizers: `cmake -B build -DENABLE_SANITIZERS=ON && cmake --build build -j$(nproc) && cd build && ctest -j$(nproc) --output-on-failure`\n- [ ] Verify no behavioral changes\n- [ ] Update any related documentation\n\n## References\n\n- Refactor Analysis: `src/quic/REFACTOR_ANALYSIS.md` (lines 107-142)\n- Guard clause pattern examples: `SocketQUICTransportParams.c`, `SocketQUICFlow.c` (exemplary files)\n- Related issue: Part of 16 nested-if issues identified across QUIC module\n\n## Context\n\nThis is one of **4 HIGH priority** nested-if issues (depth 4+) identified in the QUIC module refactor analysis. The QUIC module has 53% exemplary files, and this refactoring will bring `SocketQUICConnection-demux.c` in line with best practices demonstrated in newer code.\n\n---\n*Generated from /pipeline code analysis - QUIC module readability improvements*",
  "labels": [
    "enhancement",
    "quic"
  ],
  "state": "OPEN",
  "dependencies": []
}