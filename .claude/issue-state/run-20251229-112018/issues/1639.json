{
  "number": 1639,
  "title": "refactor(quic): improve readability in SocketQUICFrame.c",
  "body": "## Summary\n\nMultiple refactoring opportunities identified in SocketQUICFrame.c to improve code readability and maintainability through reducing nesting depth and extracting inline candidates.\n\n**Category**: Refactoring\n**Severity**: MEDIUM\n**Files Affected**: 1\n\n## Affected Locations\n\n### Nested If Statements (Depth 3)\n\n| Location | Function | Lines | Issue |\n|----------|----------|-------|-------|\n| 1 | `parse_ack_ranges` | 230-238 | Loop with nested conditionals |\n| 2 | `parse_ack_internal` | 292-314 | Nested parsing logic |\n| 3 | `parse_stream` | 461-491 | Conditional field parsing |\n| 4 | `parse_datagram` | 763-781 | Length handling logic |\n\n### Inline Candidate\n\n| Function | Lines | Size | Reason |\n|----------|-------|------|--------|\n| `parse_ack_ecn_counts` | 254-273 | 20 lines | Simple sequential varint decoding |\n\n## Problem\n\n**Nested If Statements**: Deep nesting (3+ levels) reduces code readability and makes control flow harder to follow. This pattern appears in several parsing functions where conditional logic can be flattened using guard clauses and early returns.\n\n**Inline Candidate**: The `parse_ack_ecn_counts` function is a simple helper that performs three sequential varint decodes. Since it's only called from one location (`parse_ack_internal` line 308) and has a straightforward flow, it could be inlined to reduce function call overhead and improve locality.\n\n## Recommended Fixes\n\n### 1. Flatten `parse_ack_ranges` (Lines 230-238)\n\n**Current**:\n```c\nfor (uint64_t i = 0; i < ack->range_count; i++)\n  {\n    res = decode_varint (data, len, pos, &ack->ranges[i].gap);\n    if (res != QUIC_FRAME_OK)\n      return res;\n    res = decode_varint (data, len, pos, &ack->ranges[i].length);\n    if (res != QUIC_FRAME_OK)\n      return res;\n  }\n```\n\n**Recommended**: Already optimal - early returns prevent nesting. No changes needed.\n\n### 2. Flatten `parse_ack_internal` (Lines 292-314)\n\n**Current**:\n```c\n/* Parse basic ACK fields */\nres = parse_ack_basic_fields (data, len, pos, ack);\nif (res != QUIC_FRAME_OK)\n  return res;\n\n/* Parse additional ACK ranges */\nres = parse_ack_ranges (data, len, pos, ack, arena);\nif (res != QUIC_FRAME_OK)\n  return res;\n\n/* Parse ECN counts if ACK_ECN */\nif (frame->type == QUIC_FRAME_ACK_ECN)\n  {\n    res = parse_ack_ecn_counts (data, len, pos, ack);\n    if (res != QUIC_FRAME_OK)\n      return res;\n  }\n```\n\n**Recommended**: Extract ECN handling with guard clause:\n\n```c\nres = parse_ack_basic_fields (data, len, pos, ack);\nif (res != QUIC_FRAME_OK)\n  return res;\n\nres = parse_ack_ranges (data, len, pos, ack, arena);\nif (res != QUIC_FRAME_OK)\n  return res;\n\n/* Early exit if not ACK_ECN */\nif (frame->type != QUIC_FRAME_ACK_ECN)\n  return QUIC_FRAME_OK;\n\n/* Parse ECN counts (or inline the three decode_varint calls) */\nres = decode_varint (data, len, pos, &ack->ect0_count);\nif (res != QUIC_FRAME_OK)\n  return res;\n\nres = decode_varint (data, len, pos, &ack->ect1_count);\nif (res != QUIC_FRAME_OK)\n  return res;\n\nreturn decode_varint (data, len, pos, &ack->ecn_ce_count);\n```\n\n### 3. Flatten `parse_stream` (Lines 461-491)\n\n**Current**:\n```c\nif (stream->has_offset)\n  {\n    res = decode_varint (data, len, pos, &stream->offset);\n    if (res != QUIC_FRAME_OK)\n      return res;\n  }\nelse\n  stream->offset = 0;\n\nif (stream->has_length)\n  {\n    res = decode_varint (data, len, pos, &stream->length);\n    if (res != QUIC_FRAME_OK)\n      return res;\n\n    if (*pos + stream->length > len)\n      return QUIC_FRAME_ERROR_TRUNCATED;\n\n    if (stream->length > SIZE_MAX)\n      return QUIC_FRAME_ERROR_OVERFLOW;\n  }\nelse\n  stream->length = len - *pos;\n```\n\n**Recommended**: Use early initialization with guard clauses:\n\n```c\n/* Handle offset */\nstream->offset = 0;\nif (stream->has_offset)\n  {\n    res = decode_varint (data, len, pos, &stream->offset);\n    if (res != QUIC_FRAME_OK)\n      return res;\n  }\n\n/* Handle length */\nif (!stream->has_length)\n  {\n    stream->length = len - *pos;\n  }\nelse\n  {\n    res = decode_varint (data, len, pos, &stream->length);\n    if (res != QUIC_FRAME_OK)\n      return res;\n\n    if (*pos + stream->length > len)\n      return QUIC_FRAME_ERROR_TRUNCATED;\n\n    if (stream->length > SIZE_MAX)\n      return QUIC_FRAME_ERROR_OVERFLOW;\n  }\n```\n\n### 4. Flatten `parse_datagram` (Lines 763-781)\n\n**Current**:\n```c\nif (dg->has_length)\n  {\n    SocketQUICFrame_Result res = decode_varint (data, len, pos, &dg->length);\n    if (res != QUIC_FRAME_OK)\n      return res;\n\n    if (*pos + dg->length > len)\n      return QUIC_FRAME_ERROR_TRUNCATED;\n  }\nelse\n  dg->length = len - *pos;\n\n/* Prevent overflow on 32-bit systems */\nif (dg->length > SIZE_MAX)\n  return QUIC_FRAME_ERROR_OVERFLOW;\n```\n\n**Recommended**: Similar pattern to parse_stream - early initialization:\n\n```c\n/* Set default length */\ndg->length = len - *pos;\n\nif (dg->has_length)\n  {\n    SocketQUICFrame_Result res = decode_varint (data, len, pos, &dg->length);\n    if (res != QUIC_FRAME_OK)\n      return res;\n\n    if (*pos + dg->length > len)\n      return QUIC_FRAME_ERROR_TRUNCATED;\n  }\n\n/* Prevent overflow on 32-bit systems */\nif (dg->length > SIZE_MAX)\n  return QUIC_FRAME_ERROR_OVERFLOW;\n```\n\n### 5. Inline `parse_ack_ecn_counts` (Lines 254-273)\n\n**Rationale**: \n- Only called once (from `parse_ack_internal` at line 308)\n- Simple sequential logic (three varint decodes)\n- Reduces function call overhead in hot path (ACK frame parsing)\n- Improves code locality\n\n**Action**: Remove the function definition and inline the three `decode_varint` calls directly into `parse_ack_internal` as shown in Fix #2 above.\n\n## Benefits\n\n1. **Reduced Cognitive Load**: Flatter code is easier to understand at a glance\n2. **Improved Maintainability**: Less indentation makes future changes clearer\n3. **Better Performance**: Inlining `parse_ack_ecn_counts` eliminates function call overhead\n4. **Consistent Pattern**: Guards and early returns align with existing style (e.g., `parse_ack_ranges`)\n\n## Testing Checklist\n\n- [ ] Apply refactoring changes to `/home/tetsuo/git/tetsuo-socket/src/quic/SocketQUICFrame.c`\n- [ ] Build with sanitizers: `cmake -B build -DENABLE_SANITIZERS=ON && cmake --build build -j$(nproc)`\n- [ ] Run QUIC-related tests: `cd build && ctest -j$(nproc) -R quic --output-on-failure`\n- [ ] Verify no functional changes with existing test cases\n- [ ] Check code coverage to ensure all branches tested\n\n## References\n\n- RFC 9000 Section 12 - QUIC Frames specification\n- Project style guide: Early returns and guard clauses preferred over deep nesting\n- Related module: `/home/tetsuo/git/tetsuo-socket/src/quic/SocketQUICVarInt.c` (varint encoding/decoding)\n\n---\n*Generated by /pipeline code analysis - Refactor mode*",
  "labels": [
    "enhancement",
    "good first issue",
    "quic"
  ],
  "state": "OPEN",
  "dependencies": []
}