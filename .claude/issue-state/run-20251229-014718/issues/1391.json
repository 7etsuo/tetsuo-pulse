{
  "number": 1391,
  "title": "MEDIUM: Deep nesting in http2_validate_headers reduces readability",
  "body": "## Summary\n\n**File**: `src/http/SocketHTTP2-stream.c`  \n**Function**: `http2_validate_headers()`  \n**Lines**: 753-1027  \n**Category**: Refactoring  \n**Severity**: MEDIUM  \n**Pattern ID**: `DEEP_NESTING_VALIDATE`\n\n## Issue\n\nThe main header validation loop in `http2_validate_headers()` contains deep nesting (4-5 levels) that makes the code difficult to follow and maintain. The nested structure obscures the control flow and increases cognitive load during code review.\n\n## Code Structure\n\n```c\nfor (size_t i = 0; i < count; i++)  // Level 1\n{\n    const SocketHPACK_Header *h = &headers[i];\n    \n    if (h->name_len > 0 && h->name[0] == ':')  // Level 2 - Pseudo-header path\n    {\n        if (is_trailer)  // Level 3\n        {\n            // Error handling\n            goto protocol_error;\n        }\n        \n        if (pseudo_section_ended)  // Level 3\n        {\n            // Error handling\n            goto protocol_error;\n        }\n        \n        if (h->name_len == 7 && memcmp (h->name, \":method\", 7) == 0)  // Level 3\n        {\n            if (pseudo_headers_seen & (1 << 0))  // Level 4\n            {\n                // Error handling\n                goto protocol_error;\n            }\n            \n            if (h->value_len == 7 && memcmp (h->value, \"CONNECT\", 7) == 0)  // Level 4\n            {\n                is_connect_method = 1;\n            }\n            \n            if (is_request && SocketHTTP_method_parse (...) == HTTP_METHOD_UNKNOWN)  // Level 4\n            {\n                // Error handling\n                goto protocol_error;\n            }\n        }\n        else if (h->name_len == 7 && memcmp (h->name, \":status\", 7) == 0)  // Level 3\n        {\n            if (!is_request)  // Level 4\n            {\n                for (size_t j = 0; j < h->value_len && j < 3; j++)  // Level 5 \ud83d\udd34\n                {\n                    if (h->value[j] >= '0' && h->value[j] <= '9')  // Level 6 \ud83d\udd34\ud83d\udd34\n                    {\n                        status = status * 10 + (h->value[j] - '0');\n                    }\n                }\n            }\n        }\n        // ... more else-if chains with deep nesting\n    }\n    else  // Level 2 - Regular header path\n    {\n        if (http2_field_has_uppercase (...))  // Level 3\n        {\n            // Error handling\n            goto protocol_error;\n        }\n        \n        if (h->name_len == 2 && memcmp (h->name, \"te\", 2) == 0)  // Level 3\n        {\n            if (has_te)  // Level 4\n            {\n                // Error handling\n            }\n            \n            if (h->value_len > 0 && h->value_len != 8)  // Level 4\n            {\n                // Error handling\n            }\n        }\n        \n        if (!parsed_content_length && h->name_len == 14 && ...)  // Level 3\n        {\n            for (size_t j = 0; j < h->value_len; j++)  // Level 4\n            {\n                if (h->value[j] < '0' || h->value[j] > '9')  // Level 5 \ud83d\udd34\n                {\n                    // Error handling\n                }\n            }\n        }\n    }\n}\n```\n\n## Problems with Current Structure\n\n1. **Cognitive overload**: Tracking 5-6 levels of nesting exceeds human working memory\n2. **Difficult error handling**: Many `goto protocol_error` paths scattered throughout\n3. **Hard to extract logic**: Each validation tightly coupled to the nested structure\n4. **Testing challenges**: Cannot unit test individual validation rules in isolation\n5. **Maintenance burden**: Adding new validation requires navigating complex nesting\n\n## Recommendation\n\nExtract validation logic into focused helper functions with early returns:\n\n### Refactored Structure\n\n```c\n// Main loop becomes simple dispatch\nfor (size_t i = 0; i < count; i++)\n{\n    const SocketHPACK_Header *h = &headers[i];\n    \n    if (h->name_len > 0 && h->name[0] == ':')\n    {\n        if (validate_pseudo_header(h, is_trailer, &pseudo_section_ended,\n                                   &pseudo_headers_seen, &is_connect_method,\n                                   is_request) < 0)\n            goto protocol_error;\n    }\n    else\n    {\n        pseudo_section_ended = 1;\n        \n        if (validate_regular_header(h, &has_te, &parsed_content_length,\n                                    stream) < 0)\n            goto protocol_error;\n    }\n}\n\n// Helper functions with early returns (flat structure)\nstatic int\nvalidate_pseudo_header(const SocketHPACK_Header *h, int is_trailer,\n                       int *pseudo_section_ended, int *seen,\n                       int *is_connect, int is_request)\n{\n    // Early return for errors (reduces nesting)\n    if (is_trailer)\n    {\n        SOCKET_LOG_ERROR_MSG (\"Pseudo-header in trailer\");\n        return -1;\n    }\n    \n    if (*pseudo_section_ended)\n    {\n        SOCKET_LOG_ERROR_MSG (\"Pseudo-header after regular headers\");\n        return -1;\n    }\n    \n    // Dispatch to specific pseudo-header validators\n    if (h->name_len == 7 && memcmp (h->name, \":method\", 7) == 0)\n        return validate_method_header(h, seen, is_connect, is_request);\n    \n    if (h->name_len == 7 && memcmp (h->name, \":status\", 7) == 0)\n        return validate_status_header(h, seen, is_request);\n    \n    // ... other pseudo-headers\n    \n    return 0;\n}\n\nstatic int\nvalidate_status_header(const SocketHPACK_Header *h, int *seen, int is_request)\n{\n    // Flat structure with early returns\n    if (*seen & (1 << 4))\n    {\n        SOCKET_LOG_ERROR_MSG (\"Duplicate :status\");\n        return -1;\n    }\n    \n    *seen |= (1 << 4);\n    \n    if (is_request)\n        return 0;  // Skip validation for requests\n    \n    int status = parse_status_code(h->value, h->value_len);\n    if (status < 100 || status > 599)\n    {\n        SOCKET_LOG_ERROR_MSG (\"Invalid status code\");\n        return -1;\n    }\n    \n    return 0;\n}\n```\n\n## Benefits\n\n- \u2705 **Reduced nesting**: Max 2-3 levels instead of 5-6\n- \u2705 **Early returns**: Clear error paths without deep conditionals\n- \u2705 **Testable**: Each validator can be unit tested independently\n- \u2705 **Maintainable**: Adding new validation = new function, not nested logic\n- \u2705 **Readable**: Control flow obvious at a glance\n\n## Related Issues\n\n- #1343 - Overall function length (this is part of that larger refactoring)\n- #1321 - Duplicate Content-Length parsing (also in this nested section)\n\n## Verification\n\nVerified by examining `src/http/SocketHTTP2-stream.c`:\n- Lines 753-1027 contain the deeply nested validation loop\n- Nesting depth reaches 5-6 levels in status code parsing\n- Multiple validation concerns interleaved in single loop",
  "labels": [
    "enhancement"
  ],
  "state": "OPEN",
  "dependencies": []
}