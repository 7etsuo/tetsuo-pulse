{
  "number": 2253,
  "title": "Replace assert() with runtime NULL check in http2_flow_validate()",
  "body": "## Summary\n\nThe function `http2_flow_validate()` in `src/http/SocketHTTP2-flow.c` uses `assert(conn)` for NULL pointer validation. Since `assert()` is compiled out in release builds (when `NDEBUG` is defined), this creates a potential NULL pointer dereference vulnerability in production code.\n\n## Location\n\n**File**: `src/http/SocketHTTP2-flow.c`  \n**Line**: 55  \n**Function**: `http2_flow_validate()`  \n**Pattern**: ASSERT_RUNTIME_CHECK  \n**Severity**: MEDIUM  \n**Category**: Security / Defensive Programming\n\n## Issue Details\n\n### Current Code (Line 51-65):\n```c\nstatic inline int\nhttp2_flow_validate (const SocketHTTP2_Conn_T conn,\n                     const SocketHTTP2_Stream_T stream)\n{\n  assert (conn);  // \u2190 Compiled out in release builds\n\n  if (stream && stream->conn != conn)\n    {\n      SOCKET_LOG_ERROR_MSG (\"Invalid stream %u for conn - mismatch\",\n                            stream->id);\n      return -1;\n    }\n\n  return 0;\n}\n```\n\n### Problem\n\n1. **assert(conn) is removed in release builds**: When compiling with `-DNDEBUG` (standard for production), the assert() macro expands to nothing\n2. **No fallback validation**: All 5 public flow control functions rely solely on this validation:\n   - `http2_flow_consume_recv()` (line 138)\n   - `http2_flow_update_recv()` (line 145)\n   - `http2_flow_consume_send()` (line 152)\n   - `http2_flow_update_send()` (line 159)\n   - `http2_flow_available_send()` (line 166)\n3. **NULL dereference risk**: If `conn` is NULL in production:\n   - Line 172: `conn->send_window` would dereference NULL \u2192 crash\n   - Line 73: `&conn->recv_window` would compute invalid address \u2192 undefined behavior\n\n### Security Impact\n\n| Aspect | Assessment |\n|--------|------------|\n| **Severity** | MEDIUM |\n| **Type** | NULL pointer dereference |\n| **Impact** | Denial of Service (application crash) |\n| **Exploitability** | Not exploitable for code execution |\n| **Likelihood** | LOW (callers likely validate, but not contractually guaranteed) |\n\n## Recommendation\n\nReplace `assert(conn)` with proper runtime validation:\n\n```c\nstatic inline int\nhttp2_flow_validate (const SocketHTTP2_Conn_T conn,\n                     const SocketHTTP2_Stream_T stream)\n{\n  if (conn == NULL)\n    {\n      SOCKET_LOG_ERROR_MSG (\"NULL connection pointer in flow control\");\n      return -1;\n    }\n\n  if (stream && stream->conn != conn)\n    {\n      SOCKET_LOG_ERROR_MSG (\"Invalid stream %u for conn - mismatch\",\n                            stream->id);\n      return -1;\n    }\n\n  return 0;\n}\n```\n\n### Rationale\n\nPer the codebase style guide (CLAUDE.md \u00a7 C Anti-Patterns):\n- **assert()** should only be used for programming invariants that are guaranteed by design\n- **Runtime checks** should use explicit if-statements that survive into production\n- This is a runtime validation function, not an invariant checker\n\n## Broader Context\n\n21 files in `src/http/` use `assert()`. A broader audit of assert usage may be warranted to distinguish between:\n- **Valid invariants** (e.g., `assert(size > 0)` after explicit bounds check)\n- **Runtime validation** (e.g., `assert(ptr != NULL)` for external input)\n\n## Test Plan\n\nAfter implementing the fix:\n\n- [ ] Verify NULL `conn` returns -1 instead of undefined behavior\n- [ ] Run full test suite: `cd build && ctest -j$(nproc) --output-on-failure`\n- [ ] Run with sanitizers: `ASAN_OPTIONS=detect_leaks=1 ctest -j$(nproc)`\n- [ ] Verify no performance regression (NULL check is trivial overhead)\n- [ ] Check no other code depends on assert(conn) behavior\n\n## References\n\n- **RFC 9113 \u00a7 5.2**: HTTP/2 Flow Control\n- **ISO C11 \u00a7 7.2.1.1**: assert macro behavior with NDEBUG\n- **CWE-476**: NULL Pointer Dereference\n- **Related Pattern**: ASSERT_RUNTIME_CHECK\n\n---\n\n**Analysis**: Automated security pipeline  \n**File analyzed**: src/http/SocketHTTP2-flow.c (207 lines)  \n**Analysis date**: 2025-12-30",
  "labels": [
    "bug",
    "enhancement",
    "wip:claude-1767092676-3930812"
  ],
  "state": "OPEN",
  "dependencies": []
}