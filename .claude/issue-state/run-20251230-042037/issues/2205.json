{
  "number": 2205,
  "title": "security(dns-tls): Missing return value check for getsockopt() in check_tcp_connect_complete",
  "body": "## Summary\n\nIn `src/dns/SocketDNSoverTLS.c` line 396, the return value of `getsockopt()` is not checked. If `getsockopt()` fails, the `error` variable remains 0, causing the code to incorrectly assume the TCP connection succeeded when it may have failed.\n\n## Location\n\n- **File**: `src/dns/SocketDNSoverTLS.c`\n- **Function**: `check_tcp_connect_complete()`\n- **Line**: 396\n- **Severity**: HIGH\n- **Category**: Security\n- **Pattern**: MISSING_RETURN_CHECK\n- **CWE**: CWE-252 (Unchecked Return Value)\n\n## Vulnerable Code\n\n```c\n/* Check socket error */\nint error = 0;\nsocklen_t errlen = sizeof (error);\ngetsockopt (fd, SOL_SOCKET, SO_ERROR, &error, &errlen);  // \u2190 Return value not checked\nif (error != 0)\n  {\n    close_connection (transport, conn);\n    transport->stats.handshake_failures++;\n    return -1;\n  }\n```\n\n## Impact\n\nIf `getsockopt()` fails (returns -1):\n- The `error` variable remains initialized to 0\n- The function incorrectly treats a failed connection as successful\n- TLS handshake proceeds on a broken socket\n- May lead to connection failures, crashes, or security bypasses\n\nThis is particularly problematic in DNS-over-TLS where connection validation is critical for security.\n\n## Recommendation\n\nCheck the return value before using the error code:\n\n```c\n/* Check socket error */\nint error = 0;\nsocklen_t errlen = sizeof (error);\nif (getsockopt (fd, SOL_SOCKET, SO_ERROR, &error, &errlen) != 0)\n  {\n    close_connection (transport, conn);\n    transport->stats.handshake_failures++;\n    return -1;\n  }\n\nif (error != 0)\n  {\n    close_connection (transport, conn);\n    transport->stats.handshake_failures++;\n    return -1;\n  }\n```\n\n## References\n\n- POSIX `getsockopt()` specification\n- CWE-252: Unchecked Return Value\n- RFC 7858 (DNS-over-TLS) - secure connection establishment requirements",
  "labels": [
    "bug",
    "wip:claude-1767092676-3930812"
  ],
  "state": "OPEN",
  "dependencies": []
}