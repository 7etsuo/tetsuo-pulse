{
  "number": 2351,
  "title": "[Refactor] Duplicate window bits validation pattern in ws_compression_init() (SocketWS-deflate.c:460-475)",
  "body": "## Summary\n\nDuplicated validation pattern for window bits in `ws_compression_init()`. The same validation structure is repeated for `deflate_bits` and `inflate_bits`, creating maintenance burden and potential for inconsistency.\n\n## Location\n\n**File:** `/home/tetsuo/git/tetsuo-socket/src/socket/SocketWS-deflate.c`\n**Lines:** 460-475 in function `ws_compression_init()`\n\n## Issue Details\n\n### Duplicated Code Pattern\n\n```c\n/* Validate window bits from negotiation */\ndeflate_bits = validate_window_bits (ws->handshake.client_max_window_bits);\nif (deflate_bits < 0) {\n  ws_set_error (ws, WS_ERROR_COMPRESSION,\n                \"Invalid client_max_window_bits: %d\",\n                ws->handshake.client_max_window_bits);\n  return -1;\n}\n\ninflate_bits = validate_window_bits (ws->handshake.server_max_window_bits);\nif (inflate_bits < 0) {\n  ws_set_error (ws, WS_ERROR_COMPRESSION,\n                \"Invalid server_max_window_bits: %d\",\n                ws->handshake.server_max_window_bits);\n  return -1;\n}\n```\n\n### Problem\n\nThe identical validation pattern is repeated with only parameter names changing:\n- Same validation function call\n- Same error handling structure  \n- Same return code\n- Only difference: error message formatting with different parameter names\n\n### Recommended Fix\n\nExtract into a static helper function:\n\n```c\nstatic int\nvalidate_and_store_window_bits (SocketWS_T ws, int bits, const char *type_name)\n{\n  int validated = validate_window_bits (bits);\n  if (validated < 0) {\n    ws_set_error (ws, WS_ERROR_COMPRESSION,\n                  \"Invalid %s: %d\", type_name, bits);\n    return -1;\n  }\n  return validated;\n}\n```\n\nThen refactor the calling code:\n\n```c\n/* Validate window bits from negotiation */\ndeflate_bits = validate_and_store_window_bits (\n    ws, ws->handshake.client_max_window_bits, \"client_max_window_bits\");\nif (deflate_bits < 0)\n  return -1;\n\ninflate_bits = validate_and_store_window_bits (\n    ws, ws->handshake.server_max_window_bits, \"server_max_window_bits\");\nif (inflate_bits < 0)\n  return -1;\n```\n\n## Benefits\n\n- **Reduced duplication:** 14 lines \u2192 8 lines\n- **Consistency:** Guaranteed identical validation logic\n- **Maintainability:** Single place to update validation behavior\n- **Readability:** Intent is clearer with descriptive helper name\n\n## Severity\n\n**MEDIUM** - Code quality / maintainability issue\n\n## Category\n\nRedundancy / Code Duplication\n\n## Pattern ID\n\n`DUPLICATED_WINDOW_BITS_VALIDATION`",
  "labels": [
    "enhancement"
  ],
  "state": "OPEN",
  "dependencies": []
}