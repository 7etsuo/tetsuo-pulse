{
  "number": 2313,
  "title": "refactor(simple-tcp): Break down Socket_simple_set_keepalive into smaller helpers",
  "body": "## Summary\n\nThe `Socket_simple_set_keepalive` function at line 1040 spans 65 lines and contains deeply nested platform-specific conditionals that reduce readability and testability.\n\n## Current Structure\n\n```c\nint\nSocket_simple_set_keepalive (SocketSimple_Socket_T sock, int enable,\n                              int idle_secs, int interval_secs, int count)\n{\n  // ... validation ...\n  \n  if (setsockopt (fd, SOL_SOCKET, SO_KEEPALIVE, &val, sizeof (val)) < 0)\n    { /* error */ }\n\n  if (enable)\n    {\n#ifdef TCP_KEEPIDLE\n      if (idle_secs > 0)\n        {\n          if (setsockopt (fd, IPPROTO_TCP, TCP_KEEPIDLE, &idle_secs, ...) < 0)\n            { /* error */ }\n        }\n#endif\n#ifdef TCP_KEEPINTVL\n      // Similar nested pattern...\n#endif\n#ifdef TCP_KEEPCNT\n      // Similar nested pattern...\n#endif\n    }\n  return 0;\n}\n```\n\n## Recommendation\n\nExtract platform-specific socket option setting into helper functions:\n\n```c\nstatic int\nset_keepalive_idle(int fd, int idle_secs)\n{\n#ifdef TCP_KEEPIDLE\n    if (idle_secs <= 0) return 0;\n    \n    if (setsockopt(fd, IPPROTO_TCP, TCP_KEEPIDLE, &idle_secs,\n                   sizeof(idle_secs)) < 0)\n    {\n        simple_set_error_errno(SOCKET_SIMPLE_ERR_SOCKET,\n                               \"Failed to set TCP_KEEPIDLE\");\n        return -1;\n    }\n#endif\n    return 0;\n}\n\nstatic int\nset_keepalive_interval(int fd, int interval_secs)\n{\n#ifdef TCP_KEEPINTVL\n    // Similar pattern...\n#endif\n    return 0;\n}\n\nstatic int\nset_keepalive_count(int fd, int count)\n{\n#ifdef TCP_KEEPCNT\n    // Similar pattern...\n#endif\n    return 0;\n}\n```\n\nThen simplify the main function:\n\n```c\nint\nSocket_simple_set_keepalive (SocketSimple_Socket_T sock, int enable,\n                              int idle_secs, int interval_secs, int count)\n{\n  Socket_simple_clear_error ();\n\n  if (!sock || !sock->socket)\n    {\n      simple_set_error (SOCKET_SIMPLE_ERR_INVALID_ARG, \"Invalid socket\");\n      return -1;\n    }\n\n  int fd = Socket_fd (sock->socket);\n  int val = enable ? 1 : 0;\n\n  if (setsockopt (fd, SOL_SOCKET, SO_KEEPALIVE, &val, sizeof (val)) < 0)\n    {\n      simple_set_error_errno (SOCKET_SIMPLE_ERR_SOCKET,\n                              \"Failed to set SO_KEEPALIVE\");\n      return -1;\n    }\n\n  if (!enable) return 0;\n\n  if (set_keepalive_idle(fd, idle_secs) < 0) return -1;\n  if (set_keepalive_interval(fd, interval_secs) < 0) return -1;\n  if (set_keepalive_count(fd, count) < 0) return -1;\n\n  return 0;\n}\n```\n\n## Benefits\n\n- Reduces nesting from 4 levels to 2 levels\n- Each helper function has a single responsibility\n- Easier to test platform-specific behavior\n- Improves readability and maintainability\n- Follows the \"extract function\" refactoring pattern from CLAUDE.md\n\n## File\n\n- `src/simple/SocketSimple-tcp.c`\n\n## Category\n\nRefactoring\n\n## Severity\n\nHIGH\n\n## Pattern ID\n\nLONG_FUNCTION_65",
  "labels": [],
  "state": "OPEN",
  "dependencies": []
}