{
  "number": 2272,
  "title": "refactor(quic): extract helper functions from SocketQUICInitial_derive_keys",
  "body": "## Summary\n\nThe function `SocketQUICInitial_derive_keys` in `src/quic/SocketQUICPacket-initial.c` is 91 lines long (lines 382-474), approaching the 100-line threshold recommended in CLAUDE.md. The function performs multiple sequential cryptographic operations that could be extracted into focused helper functions for better readability and testability.\n\n## Location\n\n- **File**: `/home/tetsuo/git/tetsuo-socket/src/quic/SocketQUICPacket-initial.c`\n- **Function**: `SocketQUICInitial_derive_keys` (lines 382-474)\n- **Severity**: HIGH\n- **Category**: Refactoring\n- **Pattern**: LONG_FUNCTION_100\n\n## Issue Details\n\nThe function currently handles 5 sequential steps:\n1. HKDF-Extract with version-specific salt and client DCID (lines 405-412)\n2. Derive client secret using HKDF-Expand-Label (lines 414-422)\n3. Derive server secret using HKDF-Expand-Label (lines 424-433)\n4. Derive client traffic keys (key, IV, HP key) (lines 438-447)\n5. Derive server traffic keys (key, IV, HP key) (lines 449-459)\n\nEach step has its own error handling and secret cleanup logic, contributing to the function's length.\n\n## Recommendation\n\nExtract the secret derivation logic into helper functions:\n\n```c\n/**\n * @brief Derive initial secret from connection ID.\n */\nstatic int\nderive_initial_secret(const uint8_t *salt, size_t salt_len,\n                      const SocketQUICConnectionID_T *dcid,\n                      uint8_t initial_secret[SOCKET_CRYPTO_SHA256_SIZE])\n{\n  return hkdf_extract(salt, salt_len, dcid->data, dcid->len,\n                      initial_secret, SOCKET_CRYPTO_SHA256_SIZE);\n}\n\n/**\n * @brief Derive client and server secrets from initial secret.\n */\nstatic int\nderive_endpoint_secrets(const uint8_t *initial_secret,\n                        uint8_t client_secret[SOCKET_CRYPTO_SHA256_SIZE],\n                        uint8_t server_secret[SOCKET_CRYPTO_SHA256_SIZE])\n{\n  /* Derive client secret */\n  if (hkdf_expand_label(initial_secret, SOCKET_CRYPTO_SHA256_SIZE,\n                        label_client_in, STRLEN_LIT(label_client_in),\n                        NULL, 0,\n                        client_secret, SOCKET_CRYPTO_SHA256_SIZE) < 0)\n    return -1;\n\n  /* Derive server secret */\n  if (hkdf_expand_label(initial_secret, SOCKET_CRYPTO_SHA256_SIZE,\n                        label_server_in, STRLEN_LIT(label_server_in),\n                        NULL, 0,\n                        server_secret, SOCKET_CRYPTO_SHA256_SIZE) < 0)\n    return -1;\n\n  return 0;\n}\n```\n\nThis would reduce `SocketQUICInitial_derive_keys` to a clear orchestration function under 50 lines.\n\n## Benefits\n\n1. **Improved readability**: Main function becomes high-level orchestration\n2. **Better testability**: Each helper can be unit tested independently\n3. **Easier maintenance**: Changes to individual derivation steps are isolated\n4. **Follows CLAUDE.md guidance**: Keeps functions focused and under 100 lines\n\n## Testing\n\n- Verify all existing QUIC tests pass\n- Consider adding unit tests for new helper functions\n- Ensure no functional changes in behavior\n\n## References\n\n- CLAUDE.md \"God Functions\" anti-pattern\n- RFC 9001 Section 5.2 (QUIC Initial Secret Derivation)",
  "labels": [
    "wip:claude-1767092676-3930812"
  ],
  "state": "OPEN",
  "dependencies": []
}