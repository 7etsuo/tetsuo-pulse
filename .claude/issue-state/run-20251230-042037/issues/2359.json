{
  "number": 2359,
  "title": "Use locale-independent string comparison for SNI hostname matching",
  "body": "## Issue Summary\n\n**File**: \\`src/tls/SocketTLSContext-certs.c\\`  \n**Line**: 136  \n**Function**: \\`find_sni_cert_index()\\`  \n**Severity**: LOW  \n**Category**: Security / Portability\n\n## Description\n\nThe SNI certificate lookup uses \\`strcasecmp()\\` for case-insensitive hostname comparison. While widely used, POSIX allows \\`strcasecmp()\\` to have locale-dependent behavior, which could cause incorrect hostname matching in certain locales.\n\n## Current Code\n\n\\`\\`\\`c\nstatic int\nfind_sni_cert_index (const T ctx, const char *hostname)\n{\n  for (size_t i = 0; i < ctx->sni_certs.count; i++)\n    {\n      const char *stored = ctx->sni_certs.hostnames[i];\n      if (stored && strcasecmp (stored, hostname) == 0)  // Locale-dependent\n        return (int)i;\n    }\n  return -1;\n}\n\\`\\`\\`\n\n## The Problem\n\n1. **RFC 4343** specifies that DNS names are case-insensitive using **ASCII case folding only**\n2. \\`strcasecmp()\\` may use locale-dependent comparison rules on some systems\n3. In Turkish locale, 'i' uppercases to '\u0130' (with dot), not 'I', causing \"example.com\" \u2260 \"EXAMPLE.COM\"\n4. Security-sensitive hostname matching should not depend on locale settings\n\n## Impact\n\n- **Low severity**: Most deployments use C/POSIX locale where \\`strcasecmp()\\` behaves correctly\n- **Portability issue**: Breaks in Turkish and other locales with non-ASCII case rules\n- **Consistency**: DNS/SNI matching should be locale-independent by RFC\n\n## Recommended Fix\n\nUse a locale-independent ASCII case-insensitive comparison:\n\n\\`\\`\\`c\n/**\n * @brief ASCII-only case-insensitive string comparison (locale-independent)\n * @param s1 First string\n * @param s2 Second string\n * @return 0 if equal (case-insensitive), non-zero otherwise\n *\n * Implements RFC 4343 ASCII case folding for DNS names.\n * Does not depend on locale settings.\n */\nstatic int\nascii_strcasecmp (const char *s1, const char *s2)\n{\n  const unsigned char *p1 = (const unsigned char *)s1;\n  const unsigned char *p2 = (const unsigned char *)s2;\n\n  while (*p1 && *p2)\n    {\n      unsigned char c1 = *p1;\n      unsigned char c2 = *p2;\n\n      /* ASCII case folding: A-Z -> a-z */\n      if (c1 >= 'A' && c1 <= 'Z')\n        c1 += 'a' - 'A';\n      if (c2 >= 'A' && c2 <= 'Z')\n        c2 += 'a' - 'A';\n\n      if (c1 != c2)\n        return c1 - c2;\n\n      p1++;\n      p2++;\n    }\n\n  return *p1 - *p2;\n}\n\nstatic int\nfind_sni_cert_index (const T ctx, const char *hostname)\n{\n  for (size_t i = 0; i < ctx->sni_certs.count; i++)\n    {\n      const char *stored = ctx->sni_certs.hostnames[i];\n      if (stored && ascii_strcasecmp (stored, hostname) == 0)\n        return (int)i;\n    }\n  return -1;\n}\n\\`\\`\\`\n\nAlternatively, use a utility function if one exists in \\`core/SocketUtil.h\\`:\n\n\\`\\`\\`c\nif (stored && SocketUtil_strcasecmp_ascii (stored, hostname) == 0)\n  return (int)i;\n\\`\\`\\`\n\n## Alternative: Use strcasecmp_l with C locale\n\nIf available on target platforms:\n\n\\`\\`\\`c\n#include <strings.h>\n#include <locale.h>\n\nstatic locale_t c_locale = NULL;\n\n// In initialization:\nif (!c_locale)\n  c_locale = newlocale(LC_CTYPE_MASK, \"C\", (locale_t)0);\n\n// In comparison:\nif (stored && strcasecmp_l (stored, hostname, c_locale) == 0)\n  return (int)i;\n\\`\\`\\`\n\n## References\n\n- **RFC 4343**: Domain Name System (DNS) Case Insensitivity Clarification\n- **RFC 6066**: TLS Extensions (SNI)\n- Turkish locale issue: https://en.wikipedia.org/wiki/Turkish_dotted_and_dotless_I\n\n## Testing\n\nAdd test case with Turkish locale (if available):\n\n\\`\\`\\`c\nvoid test_sni_turkish_locale(void)\n{\n  // Store original locale\n  char *old_locale = setlocale(LC_ALL, NULL);\n  \n  // Try Turkish locale\n  if (setlocale(LC_ALL, \"tr_TR.UTF-8\"))\n    {\n      SocketTLSContext_T ctx = create_test_context();\n      SocketTLSContext_add_certificate(ctx, \"example.com\", cert, key);\n      \n      // Should match regardless of case in Turkish locale\n      int idx = find_sni_cert_index(ctx, \"EXAMPLE.COM\");\n      assert(idx == 0);  // Should find the certificate\n      \n      cleanup(ctx);\n    }\n  \n  // Restore locale\n  setlocale(LC_ALL, old_locale);\n}\n\\`\\`\\`",
  "labels": [],
  "state": "OPEN",
  "dependencies": []
}