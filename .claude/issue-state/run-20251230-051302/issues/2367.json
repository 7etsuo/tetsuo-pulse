{
  "number": 2367,
  "title": "refactor: Replace cascading if statements in parse_scheme with dispatch table (SocketSimple-proxy.c:118)",
  "body": "## Refactoring: Use Dispatch Table for URL Scheme Parsing\n\n**File:** `/home/tetsuo/git/tetsuo-socket/src/simple/SocketSimple-proxy.c`  \n**Lines:** 118-166 (48 lines)  \n**Severity:** MEDIUM  \n**Category:** Refactoring  \n**Pattern ID:** CASCADING_IF_PARSE_SCHEME\n\n### Issue Description\n\nThe `parse_scheme()` function uses 7 cascading `strncasecmp()` if statements to match URL schemes. This is inefficient (O(n) string comparisons) and violates the CLAUDE.md dispatch table pattern.\n\n### Current Code\n\n```c\nstatic int\nparse_scheme(const char *url, SocketSimple_ProxyType *type, const char **rest)\n{\n  if (strncasecmp(url, \"http://\", 7) == 0) {\n    *type = SOCKET_SIMPLE_PROXY_HTTP;\n    *rest = url + 7;\n    return 0;\n  }\n  if (strncasecmp(url, \"https://\", 8) == 0) {\n    *type = SOCKET_SIMPLE_PROXY_HTTPS;\n    *rest = url + 8;\n    return 0;\n  }\n  if (strncasecmp(url, \"socks4a://\", 10) == 0) {\n    *type = SOCKET_SIMPLE_PROXY_SOCKS4A;\n    *rest = url + 10;\n    return 0;\n  }\n  // ... 4 more if statements\n  \n  return -1;\n}\n```\n\n### Problems\n\n1. **Performance**: Worst case requires 7 string comparisons (e.g., for \"socks5://\")\n2. **Order Dependency**: \"socks5h://\" must be checked before \"socks5://\" to avoid partial match\n3. **Maintainability**: Adding new schemes requires careful placement in if chain\n4. **Code Duplication**: Identical pattern repeated 7 times\n\n### Recommended Solution: Dispatch Table\n\nPer CLAUDE.md \"Dispatch Tables\" section:\n\n```c\ntypedef struct {\n  const char *prefix;\n  size_t prefix_len;\n  SocketSimple_ProxyType type;\n} SchemeEntry;\n\nstatic const SchemeEntry scheme_table[] = {\n  // Order matters: longer prefixes first to avoid partial matches\n  { \"socks5h://\",  10, SOCKET_SIMPLE_PROXY_SOCKS5H },\n  { \"socks4a://\",  10, SOCKET_SIMPLE_PROXY_SOCKS4A },\n  { \"socks5://\",    9, SOCKET_SIMPLE_PROXY_SOCKS5  },\n  { \"socks4://\",    9, SOCKET_SIMPLE_PROXY_SOCKS4  },\n  { \"socks://\",     8, SOCKET_SIMPLE_PROXY_SOCKS5  },  // Alias for socks5\n  { \"https://\",     8, SOCKET_SIMPLE_PROXY_HTTPS   },\n  { \"http://\",      7, SOCKET_SIMPLE_PROXY_HTTP    },\n};\n\n#define SCHEME_COUNT (sizeof(scheme_table) / sizeof(scheme_table[0]))\n\nstatic int\nparse_scheme(const char *url, SocketSimple_ProxyType *type, const char **rest)\n{\n  for (size_t i = 0; i < SCHEME_COUNT; i++) {\n    if (strncasecmp(url, scheme_table[i].prefix, scheme_table[i].prefix_len) == 0) {\n      *type = scheme_table[i].type;\n      *rest = url + scheme_table[i].prefix_len;\n      return 0;\n    }\n  }\n  return -1;  // Unknown scheme\n}\n```\n\n### Alternative: Trie or Hash Table (For Many Schemes)\n\nIf the number of schemes grows beyond ~10, consider:\n- **Trie**: O(k) where k = scheme length\n- **Perfect hash**: O(1) with preprocessing\n\nFor 7 schemes, linear table scan is sufficient and maintains clarity.\n\n### Benefits\n\n1. **Data-Driven**: Adding scheme = add table entry, no code change\n2. **Explicit Ordering**: Table order documents precedence clearly\n3. **Testable**: Can iterate table in tests to verify all schemes\n4. **Extensible**: Easy to add metadata (e.g., default port, TLS flag)\n5. **Cache-Friendly**: Sequential memory access vs. scattered if branches\n\n### Future Enhancement\n\nConsolidate with proxy type table from #2345:\n\n```c\ntypedef struct {\n  const char *url_prefix;\n  size_t prefix_len;\n  SocketSimple_ProxyType simple_type;\n  SocketProxyType core_type;\n  const char *display_name;\n  int default_port;\n} ProxySchemeInfo;\n\nstatic const ProxySchemeInfo proxy_schemes[] = {\n  { \"socks5h://\", 10, SOCKET_SIMPLE_PROXY_SOCKS5H, SOCKET_PROXY_SOCKS5H, \"SOCKS5h\", 1080 },\n  // ... all schemes in one table\n};\n```\n\n### Performance Analysis\n\n| Metric | If-Chain | Table |\n|--------|----------|-------|\n| Best case | 1 strcmp | 1 strcmp |\n| Avg case | 3.5 strcmp | 3.5 strcmp |\n| Worst case | 7 strcmp | 7 strcmp |\n| Code size | 48 lines | ~20 lines |\n| Extensibility | Poor | Excellent |\n\nFor this workload (7 schemes), performance is identical but code quality improves.\n\n### Related Issues\n- #2345: Consolidate all proxy type metadata into single dispatch table\n\n### References\n- CLAUDE.md: Dispatch Tables section\n- CLAUDE.md: String-Based Dispatch pattern",
  "labels": [],
  "state": "OPEN",
  "dependencies": []
}