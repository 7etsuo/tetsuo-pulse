{
  "number": 2311,
  "title": "security: Buffer overflow risk in url_decode function (SocketSimple-proxy.c:182)",
  "body": "## Security Issue: Silent Truncation in URL Decode\n\n**File:** `/home/tetsuo/git/tetsuo-socket/src/simple/SocketSimple-proxy.c`  \n**Line:** 182  \n**Severity:** HIGH  \n**Category:** Security  \n**Pattern ID:** BUFFER_OVERFLOW_URLDECODE\n\n### Issue Description\n\nThe `url_decode()` function silently truncates output when the destination buffer is too small, without signaling an error to the caller. This creates a security vulnerability where credentials or hostnames could be truncated without detection.\n\n### Current Code\n```c\nstatic size_t\nurl_decode(const char *src, size_t src_len, char *dst, size_t dst_size)\n{\n  size_t di = 0;\n  for (size_t si = 0; si < src_len && di < dst_size - 1; si++) {\n    // ... decoding logic ...\n    dst[di++] = src[si];\n  }\n  dst[di] = '\\0';\n  return di;  // Returns bytes written, but callers ignore this!\n}\n```\n\n### Vulnerability\n\n1. Function returns decoded length but **all 4 call sites (lines 238-247) ignore the return value**\n2. Silent truncation means:\n   - Usernames/passwords could be cut short without error\n   - Hostname truncation could cause connection to wrong server\n   - No indication to user that parsing failed\n\n### Attack Scenario\n\n```\nURL: socks5://averylongusernamethatexceeds128characters@proxy:1080\nResult: Username silently truncated to 127 chars, authentication may fail cryptically\n```\n\n### Recommended Fix\n\n**Option 1: Return error on truncation**\n```c\nstatic int\nurl_decode(const char *src, size_t src_len, char *dst, size_t dst_size, size_t *out_len)\n{\n  size_t di = 0;\n  for (size_t si = 0; si < src_len; si++) {\n    if (di >= dst_size - 1) {\n      return -1;  // Truncation would occur\n    }\n    // ... decode logic ...\n  }\n  dst[di] = '\\0';\n  if (out_len) *out_len = di;\n  return 0;\n}\n```\n\n**Option 2: Check return value at call sites**\n```c\nsize_t decoded_len = url_decode(rest, colon - rest, config->username, sizeof(config->username));\nif (decoded_len >= sizeof(config->username) - 1) {\n  simple_set_error(SOCKET_SIMPLE_ERR_INVALID_ARG, \"Username too long in proxy URL\");\n  return -1;\n}\n```\n\n### Affected Call Sites\n- Line 238: username decode\n- Line 240: password decode  \n- Line 246: username-only decode\n- (All ignore return value)\n\n### References\n- CWE-120: Buffer Copy without Checking Size of Input\n- CWE-\n: Improper Check for Unusual or Exceptional Conditions",
  "labels": [
    "wip:claude-1767093661-4175290"
  ],
  "state": "OPEN",
  "dependencies": []
}