{
  "number": 1718,
  "title": "refactor(http2-priority): flatten 4-level nesting in incremental parameter parsing",
  "body": "## Summary\n\nThe incremental parameter parsing section (lines 213-256) contains 4 levels of nested if statements, making the code harder to read and maintain.\n\n## Location\n\n- **File**: `src/http/SocketHTTP2-priority.c`\n- **Lines**: 213-256\n- **Function**: `SocketHTTP2_Priority_parse`\n- **Pattern**: DEEP_NESTING_4\n- **Severity**: HIGH\n\n## Current Code Structure\n\n```c\nelse if (key_len == 1 && *key_start == 'i')       // Level 1\n  {\n    p = skip_ows (p, end);\n    if (p < end && *p == '=')                      // Level 2\n      {\n        p++;\n        p = skip_ows (p, end);\n        if (p < end && *p == '?')                  // Level 3\n          {\n            p++;\n            if (p < end && *p == '1')              // Level 4\n              {\n                priority->incremental = 1;\n                p++;\n              }\n            else if (p < end && *p == '0')         // Level 4\n              {\n                priority->incremental = 0;\n                p++;\n              }\n            else                                    // Level 4\n              {\n                SOCKET_LOG_DEBUG_MSG(...);\n                return -1;\n              }\n          }\n        else\n          {\n            SOCKET_LOG_DEBUG_MSG(...);\n            return -1;\n          }\n      }\n    else\n      {\n        priority->incremental = 1;\n      }\n  }\n```\n\n## Recommendation\n\nFlatten the nesting using guard clauses and early returns:\n\n1. Extract the boolean parsing logic to a helper function\n2. Use early returns for error conditions\n3. Reduce maximum nesting depth from 4 to 2 or less\n\nExample approach:\n```c\nelse if (key_len == 1 && *key_start == 'i')\n  {\n    p = skip_ows (p, end);\n    \n    // Handle bare \"i\" (no explicit value)\n    if (p >= end || *p != '=')\n      {\n        priority->incremental = 1;\n        found_incremental = 1;\n        continue;\n      }\n    \n    // Parse explicit boolean value\n    p++; // Skip '='\n    p = skip_ows (p, end);\n    \n    if (p >= end || *p != '?')\n      {\n        SOCKET_LOG_DEBUG_MSG(\"Priority parse error: i= requires ?0 or ?1\");\n        return -1;\n      }\n    \n    p++; // Skip '?'\n    if (p >= end)\n      {\n        SOCKET_LOG_DEBUG_MSG(\"Priority parse error: invalid boolean for i\");\n        return -1;\n      }\n    \n    if (*p == '1')\n      priority->incremental = 1;\n    else if (*p == '0')\n      priority->incremental = 0;\n    else\n      {\n        SOCKET_LOG_DEBUG_MSG(\"Priority parse error: invalid boolean for i\");\n        return -1;\n      }\n    \n    p++;\n    found_incremental = 1;\n  }\n```\n\n## Impact\n\n- Improves code readability\n- Reduces cognitive complexity\n- Maintains identical functionality\n- No performance impact",
  "labels": [],
  "state": "OPEN",
  "dependencies": []
}