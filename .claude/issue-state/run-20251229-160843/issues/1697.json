{
  "number": 1697,
  "title": "refactor(hpack): flatten 5-level nesting in Decoder_decode main loop",
  "body": "## Summary\n\nThe function `SocketHPACK_Decoder_decode` has a critically deep nesting level of 5 in its main decoding loop (lines 1017-1105), making the code difficult to follow and maintain.\n\n## File\n`src/http/SocketHPACK.c`\n\n## Line Range\n1017-1105\n\n## Pattern\nDEEP_NESTING_5\n\n## Severity\nCRITICAL\n\n## Issue\nThe main decoding loop has 5 levels of nesting:\n1. `while (pos < input_len)` - main loop\n2. `if (byte & HPACK_INDEXED_MASK)` - field type detection (multiple else-if branches)\n3. Nested validation and error checks within each branch\n4. `if (hdr_count >= max_headers)` - size validation\n5. `if (decoder->decode_input_bytes > 0)` - expansion ratio check\n\n```c\nwhile (pos < input_len)                              // Level 1\n  {\n    unsigned char byte = input[pos];\n    \n    if (byte & HPACK_INDEXED_MASK)                   // Level 2\n      {\n        table_update_allowed = 0;\n        result = hpack_decode_indexed_field(...);\n        if (result != HPACK_OK)                      // Level 3\n          return result;\n      }\n    else if ((byte & HPACK_LITERAL_INDEXED_MASK) == HPACK_LITERAL_INDEXED_VAL)  // Level 2\n      {\n        table_update_allowed = 0;\n        result = hpack_decode_literal(...);\n        if (result != HPACK_OK)                      // Level 3\n          return result;\n      }\n    // ... more else-if branches ...\n    \n    result = validate_header(decoder, &header, &total_size);\n    if (result != HPACK_OK)                          // Level 3\n      return result;\n    \n    if (hdr_count >= max_headers)                    // Level 3\n      return HPACK_ERROR_LIST_SIZE;\n    \n    // ...\n    \n    if (decoder->decode_input_bytes > 0)             // Level 3\n      {\n        double current_ratio = ...;\n        if (current_ratio > decoder->max_expansion_ratio)  // Level 4-5\n          return HPACK_ERROR_BOMB;\n      }\n  }\n```\n\n## Recommendation\n\nExtract field type decoding into separate functions:\n\n```c\nstatic SocketHPACK_Result\ndecode_field_by_type(SocketHPACK_Decoder_T decoder, \n                     const unsigned char *input, size_t input_len,\n                     size_t *pos, SocketHPACK_Header *header,\n                     int *table_update_allowed, int *table_update_count,\n                     Arena_T arena)\n{\n  unsigned char byte = input[*pos];\n  \n  if (byte & HPACK_INDEXED_MASK)\n    return decode_indexed_type(decoder, input, input_len, pos, header, table_update_allowed);\n  \n  if ((byte & HPACK_LITERAL_INDEXED_MASK) == HPACK_LITERAL_INDEXED_VAL)\n    return decode_literal_indexed_type(decoder, input, input_len, pos, header, table_update_allowed, arena);\n  \n  // ... handle other types ...\n  \n  // Handle table updates\n  if ((byte & HPACK_TABLE_UPDATE_MASK) == HPACK_TABLE_UPDATE_VAL)\n    return decode_table_update_type(decoder, input, input_len, pos, table_update_allowed, table_update_count);\n  \n  return HPACK_ERROR;\n}\n\nSocketHPACK_Result\nSocketHPACK_Decoder_decode(...)\n{\n  while (pos < input_len)\n    {\n      SocketHPACK_Header header = { 0 };\n      \n      result = decode_field_by_type(decoder, input, input_len, &pos, &header,\n                                     &table_update_allowed, &table_update_count, arena);\n      \n      if (result == HPACK_OK && header.name != NULL)  // Table updates return OK with no header\n        {\n          result = validate_and_store_header(decoder, &header, headers, &hdr_count, \n                                              max_headers, &total_size);\n          if (result != HPACK_OK)\n            return result;\n        }\n    }\n  \n  return HPACK_OK;\n}\n```\n\nThis refactoring would:\n- Reduce maximum nesting from 5 to 2-3 levels\n- Make field type handling more modular and testable\n- Simplify the main decode loop to focus on iteration and validation\n- Improve readability significantly\n\n## Category\nrefactor\n\n## Priority\nHigh - CRITICAL severity affects maintainability\n\n## Analysis Source\nAutomated readability analysis - HPACK pipeline run",
  "labels": [],
  "state": "OPEN",
  "dependencies": []
}