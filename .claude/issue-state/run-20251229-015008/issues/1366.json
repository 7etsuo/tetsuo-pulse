{
  "number": 1366,
  "title": "refactor(socket-iov): consolidate poll wait error handling pattern",
  "body": "## Summary\nThe pattern of calling `SocketCommon_wait_for_fd()` and handling errors is duplicated in `socket_send_with_timeout()` and `socket_recv_with_timeout()`, with inconsistent error handling.\n\n## Location\nFile: `/home/tetsuo/git/tetsuo-socket/src/socket/Socket-iov.c`\nLines: 642-653 (send) and 714-725 (recv)\n\n## Duplicate Pattern\nBoth functions have nearly identical poll wait logic:\n\n**Send version (lines 642-653):**\n```c\nif (timeout_ms > 0) {\n    remaining_ms = get_remaining_timeout_ms(deadline_ms);\n    if (remaining_ms <= 0)\n        break; /* Timeout */\n    \n    if (SocketCommon_wait_for_fd(fd, POLLOUT, (int)remaining_ms) <= 0)\n        break; /* Timeout or error */\n}\nelse if (timeout_ms == -1) {\n    /* Block indefinitely */\n    if (SocketCommon_wait_for_fd(fd, POLLOUT, -1) < 0) {\n        SOCKET_ERROR_FMT(\"poll() failed during send\");\n        RAISE_MODULE_ERROR(Socket_Failed);\n    }\n}\n```\n\n**Recv version (lines 714-725):**\n```c\nif (timeout_ms > 0) {\n    remaining_ms = get_remaining_timeout_ms(deadline_ms);\n    if (remaining_ms <= 0)\n        break; /* Timeout */\n    \n    if (SocketCommon_wait_for_fd(fd, POLLIN, (int)remaining_ms) <= 0)\n        break; /* Timeout or error */\n}\nelse if (timeout_ms == -1) {\n    /* Block indefinitely */\n    if (SocketCommon_wait_for_fd(fd, POLLIN, -1) < 0) {\n        SOCKET_ERROR_FMT(\"poll() failed during recv\");\n        RAISE_MODULE_ERROR(Socket_Failed);\n    }\n}\n```\n\n## Issues\n1. **Duplication**: Same logic repeated verbatim (except POLLIN/POLLOUT)\n2. **Inconsistent error handling**: Timeout case returns 0, error case raises exception\n3. **Hard to maintain**: Bug fixes need to be applied twice\n4. **Violates DRY principle**\n\n## Category\n- **Type**: Redundancy / Code Quality\n- **Severity**: MEDIUM\n- **Pattern**: DUPLICATE_POLL_WAIT\n\n## Recommendation\nExtract common helper function:\n```c\n/**\n * Wait for I/O readiness with timeout and error handling\n * @return 1 if ready, 0 if timeout, raises on error\n */\nstatic int\nsocket_poll_wait_or_raise(int fd, short events, int timeout_ms,\n                         int64_t deadline_ms, const char *operation)\n{\n    int ready;\n    \n    if (timeout_ms > 0) {\n        int64_t remaining = SocketTimeout_remaining_ms(deadline_ms);\n        if (remaining <= 0)\n            return 0; /* Timeout */\n        \n        ready = SocketCommon_wait_for_fd(fd, events, (int)remaining);\n    }\n    else if (timeout_ms == -1) {\n        /* Block indefinitely */\n        ready = SocketCommon_wait_for_fd(fd, events, -1);\n    }\n    else {\n        /* timeout_ms == 0: non-blocking, skip wait */\n        return 1;\n    }\n    \n    if (ready <= 0) {\n        if (ready == 0)\n            return 0; /* Timeout */\n        SOCKET_ERROR_FMT(\"poll() failed during %s\", operation);\n        RAISE_MODULE_ERROR(Socket_Failed);\n    }\n    \n    return 1; /* Ready */\n}\n```\n\nThen use in both functions:\n```c\n// In socket_send_with_timeout:\nif (!socket_poll_wait_or_raise(fd, POLLOUT, timeout_ms, deadline_ms, \"send\"))\n    break; /* Timeout */\n\n// In socket_recv_with_timeout:\nif (!socket_poll_wait_or_raise(fd, POLLIN, timeout_ms, deadline_ms, \"recv\"))\n    break; /* Timeout */\n```\n\n## Benefits\n1. **Eliminates duplication**: ~20 lines of duplicate code removed\n2. **Consistent error handling**: Single implementation ensures consistency\n3. **Easier to maintain**: Changes to poll logic only need one edit\n4. **Better testability**: Can test poll wait logic in isolation\n5. **Clearer intent**: Function name documents what it does\n\n## Impact\n- Reduces code by ~20 lines\n- Improves maintainability\n- Makes error handling more consistent\n- Easier to add logging or metrics to poll operations\n\n## Related Issues\n- See: \"Extract duplicated timeout calculation logic\"\n- See: \"Simplify socket_send_with_timeout function complexity\"\n- All should be addressed together for maximum benefit\n\n## Labels\n`refactor`, `code-quality`, `medium-priority`, `DRY`",
  "labels": [
    "wip:claude-1766998055-906391"
  ],
  "state": "OPEN",
  "dependencies": []
}