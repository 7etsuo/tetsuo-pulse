{
  "number": 2350,
  "title": "refactor(http2): replace magic number 4 with named constant in PRIORITY_UPDATE handling",
  "body": "## Summary\n\nMagic number `4` is used repeatedly for stream ID size in PRIORITY_UPDATE frame handling. While `PRIORITY_UPDATE_MIN_PAYLOAD_SIZE` is already defined as `4` on line 30, the constant `4` appears directly in multiple places for payload construction and parsing.\n\n## Category\n\n**Type:** Redundancy / Code Quality  \n**Severity:** Medium  \n**Pattern:** MAGIC_NUMBER\n\n## Affected Locations\n\n**File:** `src/http/SocketHTTP2-priority.c`\n\n| Line | Code | Context |\n|------|------|---------|\n| 382 | `payload_len = 4 + (size_t)priority_len;` | Payload construction |\n| 391 | `memcpy(payload + 4, priority_field, ...)` | Copy priority field after stream ID |\n| 464 | `const char *priority_value = (const char *)(payload + 4);` | Skip stream ID when parsing |\n| 465 | `size_t priority_len = header->length - 4;` | Calculate priority field length |\n\n## Current Code\n\n```c\n/* Line 30 - constant already exists */\n#define PRIORITY_UPDATE_MIN_PAYLOAD_SIZE 4\n\n/* Line 382 */\npayload_len = 4 + (size_t)priority_len;\n\n/* Line 391 */\nmemcpy(payload + 4, priority_field, (size_t)priority_len);\n\n/* Lines 464-465 */\nconst char *priority_value = (const char *)(payload + 4);\nsize_t priority_len = header->length - 4;\n```\n\n## Recommendation\n\nDefine a semantically meaningful constant and use it consistently:\n\n```c\n/* Option A: Add new constant with clear semantic meaning */\n#define PRIORITY_UPDATE_STREAM_ID_SIZE 4\n\n/* Option B: Reuse existing constant (they have the same value) */\n/* PRIORITY_UPDATE_MIN_PAYLOAD_SIZE is 4 because the minimum is the stream ID */\n```\n\nThen replace all occurrences:\n\n```c\n/* Line 382 */\npayload_len = PRIORITY_UPDATE_STREAM_ID_SIZE + (size_t)priority_len;\n\n/* Line 391 */\nmemcpy(payload + PRIORITY_UPDATE_STREAM_ID_SIZE, priority_field, (size_t)priority_len);\n\n/* Lines 464-465 */\nconst char *priority_value = (const char *)(payload + PRIORITY_UPDATE_STREAM_ID_SIZE);\nsize_t priority_len = header->length - PRIORITY_UPDATE_STREAM_ID_SIZE;\n```\n\n## Benefits\n\n- Self-documenting code: makes it clear the `4` represents stream ID size\n- Single point of change if the protocol ever changes\n- Consistent with the codebase pattern of using named constants",
  "labels": [],
  "state": "OPEN",
  "dependencies": []
}