{
  "number": 2225,
  "title": "[Refactor] Eliminate code duplication in SocketDNSNegCache insert functions",
  "body": "## Summary\n\nThe four DNS negative cache insert functions share 90%+ identical code, violating DRY principle and increasing maintenance burden.\n\n## Location\n\n**File**: `/home/tetsuo/git/tetsuo-socket/src/dns/SocketDNSNegCache.c`  \n**Lines**: 408-713  \n**Functions affected**:\n- `SocketDNSNegCache_insert_nxdomain` (lines 408-472)\n- `SocketDNSNegCache_insert_nodata` (lines 474-543)\n- `SocketDNSNegCache_insert_nxdomain_with_soa` (lines 572-638)\n- `SocketDNSNegCache_insert_nodata_with_soa` (lines 641-713)\n\n## Issue\n\nAll four functions follow the same 14-step pattern:\n1. NULL checks\n2. Cache disabled check (qtype=0 validation for nodata)\n3. Name length validation\n4. Name normalization\n5. TTL capping\n6. Mutex lock\n7. Find existing entry\n8. Update if exists (with SOA copy for _with_soa variants)\n9. Evict LRU if at capacity\n10. Allocate new entry\n11. Initialize entry fields\n12. Hash insert + LRU add\n13. Stats update\n14. Mutex unlock\n\n**Duplicated code**: ~240 lines total, with only minor variations:\n- NXDOMAIN uses `qtype=0`, NODATA uses actual `qtype`\n- `_with_soa` variants call `copy_soa_to_entry()`\n\n## Pattern\n\n**Pattern ID**: `DUPLICATED_INSERT_LOGIC`  \n**Category**: Refactoring  \n**Severity**: HIGH\n\n## Recommendation\n\nExtract common logic into a shared helper function:\n\n```c\nstatic int\ninsert_entry_common(T cache, const char *qname, uint16_t qtype, \n                   uint16_t qclass, uint32_t ttl,\n                   SocketDNS_NegCacheType type,\n                   const SocketDNS_CachedSOA *soa)\n{\n  /* Shared validation, normalization, insertion logic */\n}\n```\n\nThen simplify the public API functions to thin wrappers:\n\n```c\nint\nSocketDNSNegCache_insert_nxdomain(T cache, const char *qname, \n                                  uint16_t qclass, uint32_t ttl)\n{\n  return insert_entry_common(cache, qname, 0, qclass, ttl, \n                            DNS_NEG_NXDOMAIN, NULL);\n}\n\nint\nSocketDNSNegCache_insert_nxdomain_with_soa(T cache, const char *qname,\n                                           uint16_t qclass, uint32_t ttl,\n                                           const SocketDNS_CachedSOA *soa)\n{\n  return insert_entry_common(cache, qname, 0, qclass, ttl,\n                            DNS_NEG_NXDOMAIN, soa);\n}\n```\n\n## Benefits\n\n1. **Reduced code**: ~240 lines \u2192 ~80 lines (67% reduction)\n2. **Single point of maintenance**: Bug fixes apply to all variants\n3. **Easier testing**: One code path to test instead of four\n4. **Improved readability**: Clear intent separation (API vs implementation)\n\n## Acceptance Criteria\n\n- [ ] Extract common insertion logic into `insert_entry_common()` helper\n- [ ] Refactor all four public functions to use the helper\n- [ ] Verify all existing tests pass\n- [ ] Ensure no behavioral changes (pure refactoring)\n- [ ] Confirm mutex handling remains correct\n\n## Related\n\nThis addresses a code quality issue found during automated analysis pipeline review.",
  "labels": [
    "enhancement"
  ],
  "state": "OPEN",
  "dependencies": []
}