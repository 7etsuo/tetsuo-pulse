{
  "number": 2345,
  "title": "refactor: Consolidate enum conversion switches with dispatch table (SocketSimple-proxy.c:43,356)",
  "body": "## Refactoring: Eliminate Duplicated Enum Mapping Switches\n\n**File:** `/home/tetsuo/git/tetsuo-socket/src/simple/SocketSimple-proxy.c`  \n**Lines:** 43-62 (`simple_to_core_proxy_type`), 356-375 (`Socket_simple_proxy_type_name`)  \n**Severity:** HIGH  \n**Category:** Redundancy  \n**Pattern ID:** DUPLICATED_ENUM_CONVERSION_SWITCH\n\n### Issue Description\n\nTwo functions have nearly identical switch statement structures that map `SocketSimple_ProxyType` enum values. This violates the DRY principle and the CLAUDE.md dispatch table pattern guidance.\n\n### Current Code\n\n**Function 1: Enum-to-enum conversion**\n```c\nstatic SocketProxyType\nsimple_to_core_proxy_type(SocketSimple_ProxyType type)\n{\n  switch (type) {\n    case SOCKET_SIMPLE_PROXY_NONE:   return SOCKET_PROXY_NONE;\n    case SOCKET_SIMPLE_PROXY_HTTP:   return SOCKET_PROXY_HTTP;\n    case SOCKET_SIMPLE_PROXY_HTTPS:  return SOCKET_PROXY_HTTPS;\n    case SOCKET_SIMPLE_PROXY_SOCKS4: return SOCKET_PROXY_SOCKS4;\n    // ... 7 total cases\n  }\n}\n```\n\n**Function 2: Enum-to-string conversion**\n```c\nconst char *\nSocket_simple_proxy_type_name(SocketSimple_ProxyType type)\n{\n  switch (type) {\n    case SOCKET_SIMPLE_PROXY_NONE:   return \"direct\";\n    case SOCKET_SIMPLE_PROXY_HTTP:   return \"HTTP\";\n    case SOCKET_SIMPLE_PROXY_HTTPS:  return \"HTTPS\";\n    case SOCKET_SIMPLE_PROXY_SOCKS4: return \"SOCKS4\";\n    // ... 7 total cases\n  }\n}\n```\n\n**Function 3: Default port assignment (lines 324-340)** also uses the same enum!\n\n### Problems\n\n1. **Maintenance Burden**: Adding a new proxy type requires updating 3 different switches\n2. **Error Prone**: Easy to update one switch but forget the others\n3. **Code Duplication**: Same case structure repeated 3 times\n4. **Violates CLAUDE.md**: \"Use dispatch tables to replace long switch/if-else chains\"\n\n### Recommended Solution: Dispatch Table\n\nPer CLAUDE.md section on \"Dispatch Tables\", consolidate into a single data structure:\n\n```c\ntypedef struct {\n  SocketSimple_ProxyType simple_type;\n  SocketProxyType core_type;\n  const char *name;\n  int default_port;\n} ProxyTypeInfo;\n\nstatic const ProxyTypeInfo proxy_type_table[] = {\n  { SOCKET_SIMPLE_PROXY_NONE,    SOCKET_PROXY_NONE,    \"direct\",  0    },\n  { SOCKET_SIMPLE_PROXY_HTTP,    SOCKET_PROXY_HTTP,    \"HTTP\",    8080 },\n  { SOCKET_SIMPLE_PROXY_HTTPS,   SOCKET_PROXY_HTTPS,   \"HTTPS\",   8080 },\n  { SOCKET_SIMPLE_PROXY_SOCKS4,  SOCKET_PROXY_SOCKS4,  \"SOCKS4\",  1080 },\n  { SOCKET_SIMPLE_PROXY_SOCKS4A, SOCKET_PROXY_SOCKS4A, \"SOCKS4a\", 1080 },\n  { SOCKET_SIMPLE_PROXY_SOCKS5,  SOCKET_PROXY_SOCKS5,  \"SOCKS5\",  1080 },\n  { SOCKET_SIMPLE_PROXY_SOCKS5H, SOCKET_PROXY_SOCKS5H, \"SOCKS5h\", 1080 },\n};\n\n#define PROXY_TYPE_COUNT (sizeof(proxy_type_table) / sizeof(proxy_type_table[0]))\n\nstatic const ProxyTypeInfo *\nlookup_proxy_info(SocketSimple_ProxyType type)\n{\n  for (size_t i = 0; i < PROXY_TYPE_COUNT; i++) {\n    if (proxy_type_table[i].simple_type == type)\n      return &proxy_type_table[i];\n  }\n  return NULL;  // Or return default entry\n}\n\n// Simplified accessors\nstatic SocketProxyType\nsimple_to_core_proxy_type(SocketSimple_ProxyType type)\n{\n  const ProxyTypeInfo *info = lookup_proxy_info(type);\n  return info ? info->core_type : SOCKET_PROXY_NONE;\n}\n\nconst char *\nSocket_simple_proxy_type_name(SocketSimple_ProxyType type)\n{\n  const ProxyTypeInfo *info = lookup_proxy_info(type);\n  return info ? info->name : \"unknown\";\n}\n\nstatic int\nget_default_proxy_port(SocketSimple_ProxyType type)\n{\n  const ProxyTypeInfo *info = lookup_proxy_info(type);\n  return info ? info->default_port : 8080;\n}\n```\n\n### Benefits\n\n1. **Single Source of Truth**: All proxy type metadata in one place\n2. **Easy to Extend**: Add new proxy type = add one table entry\n3. **O(1) with Array Indexing**: If enum values are sequential, use direct indexing instead of loop\n4. **Testable**: Can iterate table to verify all types have valid data\n\n### Performance Note\n\nFor 7 entries, linear search is negligible. For O(1) access if enum values are sequential:\n```c\nstatic const ProxyTypeInfo proxy_type_table[] = {\n  [SOCKET_SIMPLE_PROXY_NONE]    = { ..., \"direct\",  ... },\n  [SOCKET_SIMPLE_PROXY_HTTP]    = { ..., \"HTTP\",    ... },\n  // ... designated initializers\n};\n```\n\n### Related Issues\n- See #2338 for default port magic numbers\n\n### References\n- CLAUDE.md: Dispatch Tables section\n- CLAUDE.md: God Functions anti-pattern (applies to switch duplication)",
  "labels": [],
  "state": "OPEN",
  "dependencies": []
}