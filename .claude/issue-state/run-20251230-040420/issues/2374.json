{
  "number": 2374,
  "title": "refactor: Break down SocketTLSContext_add_pin_from_cert into smaller functions",
  "body": "## Summary\n**File**: `/home/tetsuo/git/tetsuo-socket/src/tls/SocketTLSContext-pinning.c`  \n**Lines**: 283-364  \n**Category**: Refactoring  \n**Severity**: MEDIUM  \n**Pattern**: FUNCTION_LENGTH_86\n\n## Issue\nThe function `SocketTLSContext_add_pin_from_cert` is **82 lines** long, exceeding the 50-line guideline from `CLAUDE.md`. The function performs multiple distinct operations that could be extracted into smaller, focused helper functions.\n\n## Current Implementation\nThe function currently handles:\n1. **Path validation** (lines 287-295)\n2. **Secure file opening with symlink protection** (lines 297-310)\n3. **File size validation** (lines 320-343)\n4. **Certificate parsing and SPKI hash extraction** (lines 345-359)\n5. **Pin insertion** (lines 361-363)\n\n## Code Style Guideline\nFrom `CLAUDE.md`:\n> **God Functions**\n> \n> Anti-pattern: Functions exceeding 50 lines with multiple responsibilities\n> \n> Fix: Break into smaller, focused functions\n\n## Recommendation\nRefactor into smaller helper functions:\n\n```c\n/* Helper 1: Secure file opening with symlink protection */\nstatic FILE *\nopen_cert_file_secure(const char *cert_file)\n{\n  errno = 0;\n  int fd = open(cert_file, O_RDONLY | O_NOFOLLOW);\n  if (fd == -1) {\n    if (errno == ELOOP) {\n      RAISE_CTX_ERROR_MSG(SocketTLS_Failed,\n                          \"Symlinks not allowed for certificate files: %s\",\n                          cert_file);\n    }\n    RAISE_CTX_ERROR_FMT(SocketTLS_Failed,\n                        \"Cannot open certificate file '%.200s': %s\",\n                        cert_file, Socket_safe_strerror(errno));\n  }\n\n  FILE *fp = fdopen(fd, \"r\");\n  if (!fp) {\n    close(fd);\n    RAISE_CTX_ERROR_MSG(SocketTLS_Failed,\n                        \"Cannot fdopen certificate file descriptor\");\n  }\n  return fp;\n}\n\n/* Helper 2: Validate certificate file size */\nstatic off_t\nvalidate_cert_file_size(FILE *fp)\n{\n  if (fseeko(fp, 0, SEEK_END) != 0) {\n    RAISE_CTX_ERROR_MSG(SocketTLS_Failed,\n                        \"Cannot seek in certificate file\");\n  }\n\n  off_t fsize = ftello(fp);\n  if (fsize < 0 || fseeko(fp, 0, SEEK_SET) != 0) {\n    RAISE_CTX_ERROR_MSG(SocketTLS_Failed,\n                        \"Cannot determine certificate file size\");\n  }\n\n  size_t usize = (size_t)fsize;\n  if (usize > SOCKET_TLS_MAX_CERT_FILE_SIZE ||\n      !SocketSecurity_check_size(usize)) {\n    RAISE_CTX_ERROR_FMT(SocketTLS_Failed,\n                        \"Certificate file too large: %ld bytes (max %zu)\",\n                        fsize, (size_t)SOCKET_TLS_MAX_CERT_FILE_SIZE);\n  }\n  return fsize;\n}\n\n/* Helper 3: Parse certificate and extract SPKI hash */\nstatic void\nparse_cert_and_extract_pin(FILE *fp, unsigned char *hash)\n{\n  X509 *cert = PEM_read_X509(fp, NULL, NULL, NULL);\n  if (!cert) {\n    ctx_raise_openssl_error(\"Failed to parse certificate file\");\n  }\n\n  if (tls_pinning_extract_spki_hash(cert, hash) != 0) {\n    X509_free(cert);\n    RAISE_CTX_ERROR_MSG(SocketTLS_Failed,\n                        \"Failed to extract SPKI hash from certificate\");\n  }\n\n  X509_free(cert);\n}\n\n/* Refactored main function */\nvoid\nSocketTLSContext_add_pin_from_cert(T ctx, const char *cert_file)\n{\n  assert(ctx);\n\n  if (!cert_file || !*cert_file)\n    raise_invalid_pin_param(\"Certificate file path cannot be NULL or empty\");\n\n  if (!tls_validate_file_path(cert_file)) {\n    RAISE_CTX_ERROR_FMT(SocketTLS_Failed,\n                        \"Invalid certificate file path: '%.200s'\",\n                        cert_file);\n  }\n\n  FILE *fp = open_cert_file_secure(cert_file);\n  validate_cert_file_size(fp);\n\n  unsigned char hash[SOCKET_TLS_PIN_HASH_LEN];\n  parse_cert_and_extract_pin(fp, hash);\n  fclose(fp);\n\n  pthread_mutex_lock(&ctx->pinning.lock);\n  insert_pin(ctx, hash);\n  pthread_mutex_unlock(&ctx->pinning.lock);\n}\n```\n\n## Benefits\n- Each helper function has a single, clear responsibility\n- Easier to test individual operations\n- Improved readability and maintainability\n- Follows project coding standards\n- Better error isolation and handling\n\n## References\n- CLAUDE.md section on \"God Functions\"\n- Function should not exceed 50 lines per project guidelines",
  "labels": [],
  "state": "OPEN",
  "dependencies": []
}