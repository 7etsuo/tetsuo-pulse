{
  "number": 2347,
  "title": "[Security] Unchecked integer addition in append_deflate_trailer() (SocketWS-deflate.c:170)",
  "body": "## Summary\n\nThe function `append_deflate_trailer()` in `src/socket/SocketWS-deflate.c` performs an unchecked integer addition on line 170. While the current caller protects against overflow, the function itself violates defense-in-depth security principles.\n\n## Location\n\n**File:** `/home/tetsuo/git/tetsuo-socket/src/socket/SocketWS-deflate.c`\n**Lines:** 164-179 (specifically line 170)\n**Function:** `append_deflate_trailer()`\n\n## Issue Details\n\n### Current Code (line 170):\n```c\nstatic unsigned char *\nappend_deflate_trailer (Arena_T arena, const unsigned char *input,\n                        size_t input_len, size_t *output_len)\n{\n  unsigned char *buf;\n\n  *output_len = input_len + WS_DEFLATE_TRAILER_SIZE;  // <-- UNCHECKED\n  buf = ALLOC (arena, *output_len);\n  if (!buf)\n    return NULL;\n\n  memcpy (buf, input, input_len);\n  memcpy (buf + input_len, WS_DEFLATE_TRAILER, WS_DEFLATE_TRAILER_SIZE);\n\n  return buf;\n}\n```\n\n### Problem\n\nThe addition `input_len + WS_DEFLATE_TRAILER_SIZE` is performed without overflow checking. While:\n- The current caller (`prepare_decompress_input`) checks overflow before calling (line 393)\n- `WS_DEFLATE_TRAILER_SIZE` is only 4 bytes\n- The function is static (not exposed externally)\n\nThe function itself is not self-contained and safe for standalone use, violating defense-in-depth principles.\n\n### Recommended Fix\n\nAdd overflow checking at the start of the function:\n\n```c\nstatic unsigned char *\nappend_deflate_trailer (Arena_T arena, const unsigned char *input,\n                        size_t input_len, size_t *output_len)\n{\n  unsigned char *buf;\n\n  // Defense-in-depth: check overflow even though caller checks\n  if (!SocketSecurity_check_add (input_len, WS_DEFLATE_TRAILER_SIZE, output_len)) {\n    return NULL;  // or set error if context available\n  }\n\n  buf = ALLOC (arena, *output_len);\n  if (!buf)\n    return NULL;\n\n  memcpy (buf, input, input_len);\n  memcpy (buf + input_len, WS_DEFLATE_TRAILER, WS_DEFLATE_TRAILER_SIZE);\n\n  return buf;\n}\n```\n\n## Severity\n\n**MEDIUM** - Defense-in-depth improvement. Not an active vulnerability due to caller protection, but the function should be self-contained.\n\n## Category\n\nSecurity / Defense-in-Depth\n\n## Pattern ID\n\n`UNCHECKED_INTEGER_ADD_APPEND_TRAILER`",
  "labels": [
    "bug"
  ],
  "state": "OPEN",
  "dependencies": []
}