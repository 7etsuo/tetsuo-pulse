{
  "number": 2358,
  "title": "refactor: Consider consolidating SOCKS4 buffer validation pattern",
  "body": "## Summary\n\nThe SOCKS4/4a implementation in \\`src/socket/SocketProxy-socks4.c\\` has excellent bounds checking for hostname writes (line 329), but earlier buffer writes (header, IPv4 address, marker IP) lack explicit checks. While creating issue #2337 for the security aspect, this issue tracks a potential refactoring opportunity.\n\n## Current Pattern\n\nLine 329 shows good defensive programming:\n\\`\\`\\`c\n/* Validate buffer space for hostname + null terminator */\nif (len + host_len + 1 > sizeof (conn->send_buf))\n{\n    socketproxy_set_error (conn, PROXY_ERROR_PROTOCOL,\n                         SOCKS4_ERROR_MSG_REQUEST_TOO_LARGE);\n    return -1;\n}\n\\`\\`\\`\n\n## Refactoring Opportunity\n\nConsider creating a helper macro or inline function for consistent buffer validation:\n\n\\`\\`\\`c\n/* Helper macro for bounds-checked buffer writes */\n#define SOCKS4_CHECK_BUFFER_SPACE(conn, current_len, needed_bytes) \\\n    do { \\\n        if ((current_len) + (needed_bytes) > sizeof((conn)->send_buf)) { \\\n            socketproxy_set_error((conn), PROXY_ERROR_PROTOCOL, \\\n                                 SOCKS4_ERROR_MSG_REQUEST_TOO_LARGE); \\\n            return -1; \\\n        } \\\n    } while (0)\n\n/* Usage */\nSOCKS4_CHECK_BUFFER_SPACE(conn, len, 4);  /* Before header write */\nlen += socks4_write_header(buf + len, conn->target_port);\n\nSOCKS4_CHECK_BUFFER_SPACE(conn, len, 4);  /* Before IPv4 write */\nmemcpy(buf + len, &ipv4, 4);\nlen += 4;\n\\`\\`\\`\n\nOr an inline function for better type safety:\n\\`\\`\\`c\nstatic inline int\nsocks4_ensure_buffer_space(struct SocketProxy_Conn_T *conn, \n                          size_t current_len, \n                          size_t needed_bytes)\n{\n    if (current_len + needed_bytes > sizeof(conn->send_buf)) {\n        socketproxy_set_error(conn, PROXY_ERROR_PROTOCOL,\n                             SOCKS4_ERROR_MSG_REQUEST_TOO_LARGE);\n        return -1;\n    }\n    return 0;\n}\n\\`\\`\\`\n\n## Benefits\n\n1. **Consistency**: Single point of truth for buffer validation logic\n2. **Maintainability**: Easier to update error messages or validation logic\n3. **Readability**: Self-documenting code - clear intent at call sites\n4. **DRY Principle**: Reduces code duplication\n\n## Current Risk\n\nThis is purely a code quality improvement. No functional issues exist in current implementation.\n\n## Category\n\n- Pattern: \\`REFACTOR_DRY\\`\n- Type: Code Quality / Maintainability\n- Module: SocketProxy (SOCKS4/4a)\n- Priority: Low\n\n## References\n\n- Related to: #2337 (defensive bounds checks)\n- Good pattern example: Line 329 in \\`proxy_socks4a_send_connect()\\`",
  "labels": [
    "enhancement"
  ],
  "state": "OPEN",
  "dependencies": []
}