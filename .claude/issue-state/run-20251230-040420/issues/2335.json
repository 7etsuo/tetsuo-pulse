{
  "number": 2335,
  "title": "refactor(simple-ws): consolidate duplicate WebSocket exception handlers",
  "body": "## Issue\n\n**File**: `src/simple/SocketSimple-ws.c`  \n**Lines**: 72-91, 787-803, 874-899  \n**Pattern**: `DUPLICATE_EXCEPTION_HANDLER`  \n**Severity**: MEDIUM  \n**Category**: Refactoring / DRY Violation\n\nThree functions (`Socket_simple_ws_connect_ex`, `Socket_simple_ws_accept`, `Socket_simple_ws_accept_raw`) contain nearly identical TRY/EXCEPT/FINALLY blocks for WebSocket operations.\n\n## Current Code\n\nAll three locations follow the same pattern:\n\n```c\nTRY {\n  ws = SocketWS_<operation>(...);\n  // possibly more operations\n}\nEXCEPT(SocketWS_Failed) {\n  simple_set_error(SOCKET_SIMPLE_ERR_..., \"WebSocket ... failed\");\n  exception_occurred = 1;\n}\nEXCEPT(SocketWS_ProtocolError) {\n  simple_set_error(SOCKET_SIMPLE_ERR_WS_PROTOCOL, \"WebSocket protocol error...\");\n  exception_occurred = 1;\n}\nFINALLY {\n  if (exception_occurred && ws)\n    SocketWS_free((SocketWS_T *)&ws);\n}\nEND_TRY;\n\nif (exception_occurred)\n  return NULL;\n```\n\n## Locations\n\n1. **`Socket_simple_ws_connect_ex`** (lines 71-94)\n   - Handles `SocketWS_connect()` \n   \n2. **`Socket_simple_ws_accept`** (lines 778-807)\n   - Handles `SocketWS_server_accept()` + handshake\n   \n3. **`Socket_simple_ws_accept_raw`** (lines 857-903)\n   - Handles `SocketWS_server_accept()` + handshake\n   - Also catches `Arena_Failed`\n\n## Recommendation\n\nExtract common exception handling into a helper macro or function:\n\n```c\n#define WS_TRY_OPERATION(ws_ptr, exception_flag, operation) \\\n  do { \\\n    TRY { \\\n      operation; \\\n    } \\\n    EXCEPT(SocketWS_Failed) { \\\n      simple_set_error(SOCKET_SIMPLE_ERR_SOCKET, \"WebSocket operation failed\"); \\\n      exception_flag = 1; \\\n    } \\\n    EXCEPT(SocketWS_ProtocolError) { \\\n      simple_set_error(SOCKET_SIMPLE_ERR_WS_PROTOCOL, \"WebSocket protocol error\"); \\\n      exception_flag = 1; \\\n    } \\\n    FINALLY { \\\n      if (exception_flag && *(ws_ptr)) \\\n        SocketWS_free((SocketWS_T *)(ws_ptr)); \\\n    } \\\n    END_TRY; \\\n  } while(0)\n```\n\nOr extract to a wrapper function if the exception handling logic becomes more complex.\n\n## Benefits\n\n- DRY principle: ~30 lines duplicated across 3 functions\n- Consistent exception handling across all WebSocket operations\n- Single point of maintenance for exception logic\n- Easier to add new exception types or logging\n\n## References\n\n- CLAUDE.md: Exception Safety guidelines\n- CLAUDE.md: DRY principle and code duplication anti-patterns",
  "labels": [
    "enhancement"
  ],
  "state": "OPEN",
  "dependencies": []
}