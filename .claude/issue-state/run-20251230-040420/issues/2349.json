{
  "number": 2349,
  "title": "[Refactor] Duplicate UINT_MAX validation for zlib size limits (SocketWS-deflate.c)",
  "body": "## Summary\n\nDuplicate UINT_MAX validation logic for zlib size limits appears in multiple functions in `src/socket/SocketWS-deflate.c`. The identical checks should be extracted into a helper function to improve maintainability.\n\n## Location\n\n**File:** `/home/tetsuo/git/tetsuo-socket/src/socket/SocketWS-deflate.c`\n**Lines:** 571-589 (`setup_deflate_stream`) and 676-690 (`ws_decompress_message`)\n\n## Issue Details\n\n### Duplicated Code Pattern\n\nThe same UINT_MAX validation appears twice with identical error handling:\n\n**Occurrence 1** (lines 571-589 in `setup_deflate_stream`):\n```c\nif (input_len > UINT_MAX) {\n  ws_set_error (ws, WS_ERROR_COMPRESSION,\n                \"Input size %zu exceeds zlib limit %u\", input_len, UINT_MAX);\n  return -1;\n}\nif (output_size > UINT_MAX) {\n  ws_set_error (ws, WS_ERROR_COMPRESSION,\n                \"Buffer size %zu exceeds zlib limit %u\", output_size, UINT_MAX);\n  return -1;\n}\n```\n\n**Occurrence 2** (lines 676-690 in `ws_decompress_message`):\n```c\nif (input_with_trailer_len > UINT_MAX) {\n  ws_set_error (ws, WS_ERROR_COMPRESSION,\n                \"Input size %zu exceeds zlib limit %u\",\n                input_with_trailer_len, UINT_MAX);\n  return -1;\n}\nif (buf_size > UINT_MAX) {\n  ws_set_error (ws, WS_ERROR_COMPRESSION,\n                \"Buffer size %zu exceeds zlib limit %u\", buf_size, UINT_MAX);\n  return -1;\n}\n```\n\n### Recommended Fix\n\nExtract into a static helper function:\n\n```c\nstatic int\ncheck_zlib_size_limit (SocketWS_T ws, size_t size, const char *type_name)\n{\n  if (size > UINT_MAX) {\n    ws_set_error (ws, WS_ERROR_COMPRESSION,\n                  \"%s size %zu exceeds zlib limit %u\", \n                  type_name, size, UINT_MAX);\n    return -1;\n  }\n  return 0;\n}\n```\n\nThen replace both occurrences:\n\n```c\n// In setup_deflate_stream:\nif (check_zlib_size_limit (ws, input_len, \"Input\") < 0)\n  return -1;\nif (check_zlib_size_limit (ws, output_size, \"Buffer\") < 0)\n  return -1;\n\n// In ws_decompress_message:\nif (check_zlib_size_limit (ws, input_with_trailer_len, \"Input\") < 0)\n  return -1;\nif (check_zlib_size_limit (ws, buf_size, \"Buffer\") < 0)\n  return -1;\n```\n\n## Benefits\n\n- **Maintainability:** Single source of truth for zlib size validation\n- **Consistency:** Guaranteed identical error messages across call sites\n- **Extensibility:** Easy to add logging or metrics in one place\n\n## Severity\n\n**MEDIUM** - Code quality / maintainability issue\n\n## Category\n\nRedundancy / Code Duplication\n\n## Pattern ID\n\n`DUPLICATED_UINT_MAX_VALIDATION`",
  "labels": [
    "enhancement"
  ],
  "state": "OPEN",
  "dependencies": []
}