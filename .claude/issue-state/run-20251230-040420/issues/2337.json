{
  "number": 2337,
  "title": "Add defensive bounds checks in SocketProxy-socks4.c",
  "body": "## Summary\n\nThe SOCKS4/4a implementation in `src/socket/SocketProxy-socks4.c` performs several buffer write operations without explicit bounds checking. While the current buffer size (65536 bytes) makes overflow impossible in practice, adding defensive checks aligns with secure coding practices and prevents future regressions if buffer sizes change.\n\n## Affected Functions\n\n### 1. `proxy_socks4_send_connect()` - Lines 247, 250\n\n**Missing checks:**\n```c\n/* Line 247: Write header without bounds check */\nlen += socks4_write_header (buf + len, conn->target_port);\n\n/* Line 250: Write IPv4 address without bounds check */\nmemcpy (buf + len, &ipv4, 4);\nlen += 4;\n```\n\n### 2. `proxy_socks4a_send_connect()` - Lines 311, 314\n\n**Missing checks:**\n```c\n/* Line 311: Write header without bounds check */  \nlen += socks4_write_header (buf + len, conn->target_port);\n\n/* Line 314: Write marker IP without bounds check */\nmemcpy (buf + len, SOCKS4A_MARKER_IP, 4);\nlen += 4;\n```\n\n## Recommended Fix\n\nAdd explicit bounds checks before buffer writes, following the pattern already used at line 329:\n\n\\`\\`\\`c\n/* Before socks4_write_header() */\nif (len + 4 > sizeof(conn->send_buf)) {\n    socketproxy_set_error(conn, PROXY_ERROR_PROTOCOL,\n                         SOCKS4_ERROR_MSG_REQUEST_TOO_LARGE);\n    return -1;\n}\n\n/* Before IPv4/marker memcpy */\nif (len + 4 > sizeof(conn->send_buf)) {\n    socketproxy_set_error(conn, PROXY_ERROR_PROTOCOL,\n                         SOCKS4_ERROR_MSG_REQUEST_TOO_LARGE);\n    return -1;\n}\n\\`\\`\\`\n\nAlternatively, add a compile-time assertion at function start:\n\n\\`\\`\\`c\n/* Ensure minimum buffer size for SOCKS4 request */\n_Static_assert(SOCKET_PROXY_BUFFER_SIZE >= 520, \n               \"Buffer too small for SOCKS4a max request\");\n\\`\\`\\`\n\n## Current Risk Assessment\n\n**Severity**: MEDIUM (defensive programming issue)\n**Exploitability**: NONE (current buffer is 65536 bytes, max request ~520 bytes)\n**Impact**: Would only matter if \\`SOCKET_PROXY_BUFFER_SIZE\\` reduced below 520 bytes\n\n## Category\n\n- Pattern: \\`MISSING_BOUNDS_CHECK\\`\n- Type: Defensive Programming\n- Module: SocketProxy (SOCKS4/4a)\n\n## References\n\n- Good example of bounds checking: Line 329 in \\`proxy_socks4a_send_connect()\\`\n- Buffer size constant: \\`SOCKET_PROXY_BUFFER_SIZE\\` (65536) in SocketProxy-private.h\n- Maximum SOCKS4a request: 4 (header) + 4 (IP) + 256 (userid) + 1 (null) + 255 (hostname) + 1 (null) = 521 bytes",
  "labels": [
    "enhancement"
  ],
  "state": "OPEN",
  "dependencies": []
}