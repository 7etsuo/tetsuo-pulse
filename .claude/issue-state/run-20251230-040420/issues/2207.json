{
  "number": 2207,
  "title": "security(dns-tls): Missing return value checks for socket_util_safe_strncpy() in configure",
  "body": "## Summary\n\nIn `src/dns/SocketDNSoverTLS.c`, the `SocketDNSoverTLS_configure()` function calls `socket_util_safe_strncpy()` multiple times without checking return values. If strings are truncated due to insufficient buffer space, the DoT transport may connect to wrong servers or use incorrect SNI names, leading to connection failures or security issues.\n\n## Location\n\n- **File**: `src/dns/SocketDNSoverTLS.c`\n- **Function**: `SocketDNSoverTLS_configure()`\n- **Lines**: 1043, 1050, 1056, 1062, 1067\n- **Severity**: MEDIUM\n- **Category**: Security\n- **Pattern**: MISSING_RETURN_CHECK\n- **CWE**: CWE-252 (Unchecked Return Value)\n\n## Vulnerable Code\n\n```c\nsocket_util_safe_strncpy (server->address, config->server_address, \n                          sizeof (server->address));  // Line 1043 - no check\n\nif (config->server_name)\n  {\n    socket_util_safe_strncpy (server->server_name, config->server_name,\n                              sizeof (server->server_name));  // Line 1050 - no check\n  }\nelse\n  {\n    socket_util_safe_strncpy (server->server_name, config->server_address,\n                              sizeof (server->server_name));  // Line 1056 - no check\n  }\n\nif (config->spki_pin)\n  {\n    socket_util_safe_strncpy (server->spki_pin, config->spki_pin, \n                              sizeof (server->spki_pin));  // Line 1062 - no check\n  }\n\nif (config->spki_pin_backup)\n  {\n    socket_util_safe_strncpy (server->spki_pin_backup, config->spki_pin_backup,\n                              sizeof (server->spki_pin_backup));  // Line 1067 - no check\n  }\n```\n\n## Impact\n\nIf any of these strings are truncated:\n- **Server address truncation**: May connect to wrong IP address or fail DNS resolution\n- **Server name (SNI) truncation**: TLS handshake will fail with hostname mismatch\n- **SPKI pin truncation**: Pin validation will fail, breaking pinned connections\n\nAll of these can lead to:\n- DoS (connection failures)\n- Security bypass (if truncated SNI matches wrong certificate)\n- Unexpected behavior in production\n\n## Buffer Sizes\n\nFrom `struct ServerConfig` (lines 97-106):\n```c\nchar address[64];        // May be too small for long IPv6 addresses\nchar server_name[256];   // Usually sufficient\nchar spki_pin[64];       // Base64-encoded SHA256 (44 chars + null)\nchar spki_pin_backup[64];\n```\n\n## Recommendation\n\nCheck all return values and handle truncation errors:\n\n```c\nif (!socket_util_safe_strncpy (server->address, config->server_address, \n                               sizeof (server->address)))\n  return -1;  /* Address truncated */\n\nif (config->server_name)\n  {\n    if (!socket_util_safe_strncpy (server->server_name, config->server_name,\n                                   sizeof (server->server_name)))\n      return -1;  /* Server name truncated */\n  }\nelse\n  {\n    if (!socket_util_safe_strncpy (server->server_name, config->server_address,\n                                   sizeof (server->server_name)))\n      return -1;  /* Address used as SNI, truncated */\n  }\n\nif (config->spki_pin)\n  {\n    if (!socket_util_safe_strncpy (server->spki_pin, config->spki_pin,\n                                   sizeof (server->spki_pin)))\n      return -1;  /* Pin truncated */\n  }\n\nif (config->spki_pin_backup)\n  {\n    if (!socket_util_safe_strncpy (server->spki_pin_backup, config->spki_pin_backup,\n                                   sizeof (server->spki_pin_backup)))\n      return -1;  /* Backup pin truncated */\n  }\n```\n\n## References\n\n- CWE-252: Unchecked Return Value\n- CWE-119: Improper Restriction of Operations within the Bounds of a Memory Buffer",
  "labels": [
    "bug"
  ],
  "state": "OPEN",
  "dependencies": []
}