{
  "number": 2340,
  "title": "refactor(simple-ws): extract duplicate strdup pattern for close_reason",
  "body": "## Issue\n\n**File**: `src/simple/SocketSimple-ws.c`  \n**Lines**: 331-340, 359-368  \n**Pattern**: `DUPLICATE_STRDUP_PATTERN`  \n**Severity**: LOW  \n**Category**: Refactoring / DRY Violation\n\nIn `Socket_simple_ws_recv()`, identical code for handling close reason strdup appears twice within the same function.\n\n## Current Code\n\nThe pattern appears at two locations:\n\n**Lines 331-340** (inside `EXCEPT(SocketWS_Closed)` block):\n```c\nconst char *reason = SocketWS_close_reason (ws->ws);\nif (reason)\n  {\n    msg->close_reason = strdup (reason);\n    /* If strdup fails, set to NULL - caller can still handle close */\n    if (!msg->close_reason)\n      {\n        /* Log warning but continue - close event is more important */\n      }\n  }\n```\n\n**Lines 359-368** (inside `if (ret == 0)` block for clean close):\n```c\nconst char *reason = SocketWS_close_reason (ws->ws);\nif (reason)\n  {\n    msg->close_reason = strdup (reason);\n    /* If strdup fails, set to NULL - caller can still handle close */\n    if (!msg->close_reason)\n      {\n        /* Log warning but continue - close event is more important */\n      }\n  }\n```\n\n## Recommendation\n\nExtract to a helper function:\n\n```c\nstatic void\ncopy_ws_close_info(SocketSimple_WS_T ws, SocketSimple_WSMessage *msg)\n{\n  msg->type = SOCKET_SIMPLE_WS_CLOSE;\n  msg->close_code = SocketWS_close_code(ws->ws);\n  \n  const char *reason = SocketWS_close_reason(ws->ws);\n  if (reason) {\n    msg->close_reason = strdup(reason);\n    /* If strdup fails, msg->close_reason will be NULL\n     * Caller can still handle close event */\n  }\n}\n```\n\nThen use it in both locations:\n\n```c\n// In EXCEPT(SocketWS_Closed) handler:\ncopy_ws_close_info(ws, msg);\nreturn 0;\n\n// In clean close handling:\ncopy_ws_close_info(ws, msg);\nreturn 0;\n```\n\n## Benefits\n\n- DRY principle: Eliminates 10 lines of duplication\n- Single source of truth for close info handling\n- Easier to add logging or enhance error handling\n- More maintainable\n\n## Context\n\nThis duplication likely occurred because the function handles both:\n1. Exception-based close (via `EXCEPT(SocketWS_Closed)`)\n2. Normal close detection (via `ret == 0` check)\n\nBoth paths need identical handling of close information.\n\n## Location\n\n- Function: `Socket_simple_ws_recv` (lines 302-384)\n- Duplicated code: lines 331-340 and 359-368",
  "labels": [
    "enhancement",
    "good first issue"
  ],
  "state": "OPEN",
  "dependencies": []
}