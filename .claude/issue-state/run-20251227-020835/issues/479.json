{
  "number": 479,
  "title": "refactor(socket): extract duplicate restore_blocking_mode helper",
  "body": "## Duplication Found\n\nBoth `Socket-connect.c` and `Socket-convenience.c` contain nearly identical implementations of a helper function to restore blocking mode on a socket file descriptor after an operation. Both functions:\n\n1. Call `fcntl(fd, F_SETFL, original_flags)` to restore the original flags\n2. Log a warning via `SocketLog_emitf()` if the operation fails\n3. Include the fd, errno, and strerror in the warning message\n\n## Locations\n\n- `src/socket/Socket-connect.c:66-77` - `socket_restore_blocking_mode(T socket, int original_flags, const char *operation)`\n- `src/socket/Socket-convenience.c:69-79` - `restore_blocking_mode(int fd, int original_flags)`\n\n## Current Implementations\n\n**Socket-connect.c:**\n```c\nstatic void\nsocket_restore_blocking_mode (T socket, int original_flags,\n                              const char *operation)\n{\n  int fd = SocketBase_fd (socket->base);\n  if (fcntl (fd, F_SETFL, original_flags) < 0)\n    {\n      SocketLog_emitf (SOCKET_LOG_WARN, \"SocketConnect\",\n                       \"Failed to restore blocking mode after %s \"\n                       \"(fd=%d, errno=%d): %s\",\n                       operation, fd, errno, Socket_safe_strerror (errno));\n    }\n}\n```\n\n**Socket-convenience.c:**\n```c\nstatic void\nrestore_blocking_mode (int fd, int original_flags)\n{\n        if (fcntl (fd, F_SETFL, original_flags) < 0)\n                {\n                        SocketLog_emitf (SOCKET_LOG_WARN, SOCKET_LOG_COMPONENT,\n                                         \"Failed to restore blocking mode \"\n                                         \"(fd=%d, errno=%d): %s\",\n                                         fd, errno, Socket_safe_strerror (errno));\n                }\n}\n```\n\n## Proposed Extraction\n\nCreate a shared helper function in `src/socket/SocketCommon.c` (or `SocketCommon-private.h` as a static inline):\n\n```c\nstatic inline void\nsocket_common_restore_blocking_mode(int fd, int original_flags, const char *component)\n{\n    if (fcntl(fd, F_SETFL, original_flags) < 0)\n    {\n        SocketLog_emitf(SOCKET_LOG_WARN, component,\n                        \"Failed to restore blocking mode (fd=%d, errno=%d): %s\",\n                        fd, errno, Socket_safe_strerror(errno));\n    }\n}\n```\n\nBoth call sites would then use this shared implementation with their respective component names.\n\n## Lines Saved\n\n~10-12 lines (one full function definition eliminated)\n\n## Category\n\nRedundancy",
  "labels": [],
  "state": "OPEN",
  "dependencies": []
}