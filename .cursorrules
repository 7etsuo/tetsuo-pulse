# Socket Library Cursor Rules

## 1. Code Style (GNU C + C Interfaces and Implementations)
- Use 8-space indentation; never mix tabs and spaces.
- Keep lines ≤ 80 characters; wrap earlier if readability improves.
- Place the return type on a dedicated line for every function definition:
```c
ReturnType
  FunctionName(...)
  {
      ...
  }
  ```
- Open braces stay on the same line for functions and control structures.
- Pointer alignment is `type *ptr`; never `type* ptr`.
- Cast unused parameters to void: `(void)param;`.
- Order includes: system headers first, then project headers.
- End every implementation file with `#undef T` and no trailing whitespace.

## 2. Documentation Standards
- Every header and source file begins with a Doxygen module block stating purpose, features, thread safety, and usage example.
- Document **every** function (public or static) with Doxygen comments including: one-line summary, `@param`, `Returns:`, `Raises:`, and `Thread-safe:` lines.
- Document struct members inside implementation files with `/**< ... */` trailing comments or dedicated Doxygen blocks.
- Update documentation when changing function behavior; do not leave stale comments.

## 3. Exception-Based Error Handling
- Use `TRY/EXCEPT/FINALLY/END_TRY` macros for all operations that can fail.
- Raise module-specific exceptions (`Socket_Failed`, `SocketPoll_Failed`, `SocketDNS_Failed`, etc.) through thread-local wrappers (`RAISE_SOCKET_ERROR`, `RAISE_POLL_ERROR`, etc.).
- Populate error messages via module error buffers (`MODULE_ERROR_FMT`, `MODULE_ERROR_MSG`).
- Never return error codes for failure reporting; use exceptions exclusively.
- Wrap resource acquisition in TRY blocks and release in FINALLY blocks in reverse order.

## 4. Memory Management (Arena Pattern)
- Allocate related objects with `ALLOC`/`CALLOC` macros tied to an `Arena_T`.
- Only allocate arenas themselves (or OS-level resources) with `malloc`/`calloc`.
- Dispose arenas exactly once via `Arena_dispose(&arena)` inside FINALLY blocks.
- Never mix arena-managed and manually-freed allocations for the same lifetime.
- When cancelling accepted sockets or pooled connections, ensure `Socket_free` is called and any pool removal (`SocketPool_remove`) occurs before arena disposal.

## 5. Header Organization & Opaque Types
- Guard headers with `_INCLUDED` suffix (e.g., `#ifndef SOCKET_INCLUDED`).
- Headers expose only opaque pointer types: `#define T Module_T` followed by `typedef struct T *T;`.
- Do not place struct definitions in headers; define them in the corresponding `.c` file.
- Place forward declarations before struct definitions in implementation files.
- Undefine the `T` macro (`#undef T`) at the bottom of both headers and sources.

## 6. Naming Conventions
- Prefix public functions with their module (`Socket_*`, `SocketDNS_*`, `SocketPoll_*`, etc.).
- Use static descriptive names (no module prefix) for internal helpers.
- Define constants/macros in uppercase with module prefixes (e.g., `SOCKET_MAX_BACKLOG`).
- Place configuration constants in `SocketConfig.h` (or module-specific headers) instead of hardcoding values.

## 7. Code Organization & Function Size
- Group static helper functions at the top of each `.c` file before public APIs.
- Keep every function ≤ 20 lines; extract helpers aggressively.
- One logical concept per file; split files that exceed ~400 lines or mix unrelated logic.
- Use `const` qualifiers for parameters that must not be modified.

## 8. Safety Practices
- Validate all inputs with explicit macros (e.g., `SOCKET_VALID_PORT`).
- Assert on programming errors (NULL pointers, invalid state) before main logic.
- Check every system call return value; wrap closings with `SAFE_CLOSE`.
- Protect shared state with mutexes and document thread-safety guarantees.
- Use thread-local storage for per-thread data (`__thread`/`__declspec(thread)`).
- Guard against overflow/underflow before arithmetic (prefer size-safe helper functions).

## 9. Socket Lifecycle Discipline (Leak Prevention)
- Every call to `Socket_accept` must flow through cleanup paths that invoke both `SocketPool_remove` (when pooled) and `Socket_free`.
- Immediately track accepted sockets in tests and free them once finished; tests must assert that `Socket_debug_live_count()` returns zero to catch leaks early.
- When using `SocketPool`, always call `SocketPool_cleanup(pool, 0)` before freeing the pool to release internal socket references.
- Integration tests must leave no outstanding sockets, threads, or arenas; add explicit assertions if necessary.

## 10. Module-Specific Patterns
- **SocketDNS**: Maintain queue/hash invariants, free `addrinfo` results on cancellation, and document blocking caveats.
- **SocketPoll**: Convert epoll events with helper functions; never duplicate epoll translation logic.
- **SocketPool**: Hash lookups must use `socket_hash` helper; keep mutex locked only for critical sections and ensure `cleanup_buffer` is reused, not reallocated.
- **SocketBuf**: Enforce wrap-around invariants and sanity check capacities after each write/read.

## 11. Testing Requirements
- Tests should use TRY/FINALLY to ensure resources are freed even when assertions fail.
- Prefer integration tests that verify no socket/resource leaks (`Socket_debug_live_count()` == 0) after execution.
- Avoid duplicating test helpers; share tracking utilities (e.g., socket trackers) across suites when possible.

## 12. Refactoring & Review Gate
- Refactorings must preserve functionality while improving readability, safety, or performance.
- Pull requests and code reviews must reject changes violating these rules, especially those that:
  - Introduce functions > 20 lines
  - Reintroduce magic numbers
  - Bypass exception handling
  - Leave accepted sockets un-freed or pools uncleared
- Use the refactor command guidance (see `.cursor/commands/refactor.md`) to enforce these standards during automated analysis.

Adhering to these rules ensures the socket library remains leak-free, consistent with Hanson’s C Interfaces and Implementations methodology, and aligned with GNU C style across all modules.

## Documentation Restrictions

- **DO NOT** add references to "C Interfaces and Implementations" in README.md or any documentation files
- Keep documentation focused on the library's features and usage without external book references

