# Socket Library Cursor Rules (Comprehensive Ruleset)

This .cursorrules enforces CII/GNU standards + TLS1.3 hardening for production socket lib.
It consolidates all architectural, design, and implementation rules for the codebase.

## 1. TLS1.3 Hardening (CRITICAL)
**ALWAYS** use the TLS1.3-only configuration defined in SocketTLSConfig.h:

```c
SSL_CTX_set_min_proto_version(ctx, SOCKET_TLS_MIN_VERSION);  /* TLS1.3 min */
SSL_CTX_set_max_proto_version(ctx, SOCKET_TLS_MAX_VERSION);  /* TLS1.3 max */
SSL_CTX_set_ciphersuites(ctx, SOCKET_TLS13_CIPHERSUITES);    /* Modern PFS suites */
```

**Rationale**: Eliminates legacy protocol/cipher vulnerabilities while enabling faster handshakes and forward secrecy.

## 2. Coding Style (GNU C)

### Header Files
- **ALWAYS** use include guards with `_INCLUDED` suffix:
  ```c
  #ifndef FILENAME_INCLUDED
  #define FILENAME_INCLUDED
  ...
  #endif
  ```
- **ALWAYS** include module documentation at the top.

### Functions
- **ALWAYS** use Doxygen-style comments (`/** ... */`).
- **ALWAYS** put function return type on a separate line:
  ```c
  ReturnType
  FunctionName(Type1 param1, Type2 param2)
  {
      // Body
  }
  ```
- **ALWAYS** use `static` for private helper functions.

### Macros
- **ALWAYS** use `do { ... } while(0)` for complex macros.
- **ALWAYS** use ALL_CAPS for constants and macros.
- **ALWAYS** parenthesize macro arguments: `#define VALID(x) ((x) > 0)`.

## 3. Architecture & Design Patterns

### Layered Architecture
1. **Foundation**: `Arena` (Memory), `Except` (Errors).
2. **Utilities**: `SocketUtil` (Logging, Metrics, Events, Error Handling - consolidated).
3. **Base Abstraction**: `SocketCommon` (Shared base for Socket/SocketDgram).
4. **Core I/O**: `Socket` (TCP/Unix), `SocketDgram` (UDP), `SocketBuf` (Buffers), `SocketDNS` (Async DNS).
5. **Event System**: `SocketPoll` (epoll/kqueue/poll abstraction).
6. **Application**: `SocketPool` (Connection management).

### Resource Management
- **Acquisition Order**: Arena -> Server Socket -> Poll -> Connection Pool -> Buffers.
- **Cleanup Order**: Reverse of acquisition.
- **ALWAYS** use `Arena` for memory management of related objects.

### Socket Base Delegation Pattern
- **ALWAYS** use `SocketBase_T` for shared socket state (fd, arena, endpoints, timeouts):
  ```c
  struct SocketBase_T
  {
      int fd;                              /* Socket file descriptor */
      Arena_T arena;                       /* Per-socket memory arena */
      int domain;                          /* AF_INET, AF_INET6, AF_UNIX */
      int type;                            /* SOCK_STREAM, SOCK_DGRAM */
      struct sockaddr_storage local_addr;  /* Local endpoint */
      struct sockaddr_storage remote_addr; /* Remote endpoint */
      SocketTimeouts_T timeouts;           /* Timeout configuration */
      /* ... */
  };
  ```
- Stream sockets (`Socket_T`) add TLS fields via composition.
- Datagram sockets (`SocketDgram_T`) use base directly.

### Opaque Types
- **ALWAYS** use the `T` macro pattern for public opaque types:
  ```c
  #define T ModuleName_T
  typedef struct T *T;
  /* In .c file: struct T { ... }; */
  ```

## 4. Error Handling (Exceptions)

### Pattern
- **ALWAYS** use the `Except_T` system with `TRY`, `EXCEPT`, `FINALLY`, `END_TRY`.
- **NEVER** return error codes for fatal/exceptional conditions; raise exceptions.

### Thread Safety (CRITICAL)
- **ALWAYS** use thread-local storage for error buffers and exception copies.
- **NEVER** modify global exception structures directly.
- **Use Centralized Macros** from `SocketUtil.h`:
  ```c
  /* Declare thread-local exception (use once per module) */
  SOCKET_DECLARE_MODULE_EXCEPTION(ModuleName);
  
  /* Raise with detailed error message (uses socket_error_buf) */
  #define RAISE_MODULE_ERROR(e) SOCKET_RAISE_MODULE_ERROR(ModuleName, e)
  ```

### Error Formatting
- **Use** `SOCKET_ERROR_FMT(fmt, ...)` for errors with errno information.
- **Use** `SOCKET_ERROR_MSG(fmt, ...)` for errors without errno.
- Both macros auto-emit to logging and handle truncation.

### Safe System Calls
- **ALWAYS** use `SAFE_CLOSE(fd)` which handles `EINTR` correctly (per POSIX.1-2008, do NOT retry close on EINTR).

## 5. Memory Management

### Arenas
- **ALWAYS** use `Arena_alloc` / `Arena_calloc` for object lifecycle management.
- **ALWAYS** use `Arena_dispose` to free entire contexts.

### Safety
- **ALWAYS** check for integer overflow before allocation or buffer arithmetic.
- **ALWAYS** use `SocketBuf_secureclear` for sensitive data.
- **Alignment**: Use `union align` to ensure proper memory alignment.

## 6. Module Specific Rules

### SocketCommon (Base Abstraction)
- **Purpose**: Shared functionality between `Socket` and `SocketDgram`.
- **Functions**: `SocketCommon_new_base()`, `SocketCommon_free_base()`, address resolution, socket options.
- **Pattern**: Both Socket_T and SocketDgram_T contain a `SocketBase_T base` pointer.

### Socket (TCP/Unix)
- **Structure**: Contains `SocketBase_T base` + TLS fields (when `SOCKET_HAS_TLS` defined).
- **DNS**: `Socket_bind`/`Socket_connect` may block on DNS. Use `SocketDNS` for non-blocking resolution.
- **Unix Domain**: Support `AF_UNIX`. Prefer absolute paths. Handle stale socket files (unlink before bind).
- **Lifecycle**: Use `Socket_new()`, `Socket_free()`. Track with `Socket_debug_live_count()`.

### SocketDgram (UDP)
- **Structure**: Contains `SocketBase_T base` only (simpler than Socket_T).
- **Connectionless**: No `listen`/`accept`.
- **Sizing**: Respect `UDP_MAX_PAYLOAD` (65507). Prefer `SAFE_UDP_SIZE` (1472) to avoid fragmentation.
- **Pattern**: Use `SocketDgram_recvfrom`/`SocketDgram_sendto`.

### SocketPoll (Events)
- **Edge Triggered**: Always use Edge Triggered mode (`EPOLLET`) where available.
- **Backends**: Abstract `epoll` (Linux), `kqueue` (BSD/macOS), `poll` (POSIX fallback).
- **Data Map**: Hash table mapping `Socket` -> `User Data` with `SOCKET_DATA_HASH_SIZE` buckets.
- **Hash Function**: Golden ratio multiplicative hash (`HASH_GOLDEN_RATIO = 2654435761u`).

### SocketPool (Connection Pooling)
- **Lookup**: O(1) hash table lookup for connections (`SOCKET_HASH_TABLE_SIZE = 1021`).
- **Thread Safety**: Protect pool operations with mutexes.
- **Buffer Reuse**: Reuse `SocketBuf` instances to reduce allocation churn.

### SocketDNS (Async)
- **Thread Pool**: Use worker threads for `getaddrinfo`.
- **Signaling**: Use pipe to signal completion to `SocketPoll`.
- **Ownership**: Caller owns `addrinfo` result and MUST call `freeaddrinfo`.
- **Timeout**: Propagate via `SocketDNS_request_settimeout()`.

## 7. Naming Conventions
- **Types**: `ModuleName_T` (e.g., `Socket_T`, `Arena_T`).
- **Functions**: `Module_Verb` (e.g., `Socket_bind`, `Arena_alloc`).
- **Private**: `static` functions, lower_snake_case (e.g., `socket_hash`, `translate_events`).
- **Constants**: `MODULE_NAME` prefix, ALL_CAPS.

## 8. Platform Requirements
- **Target**: Linux/POSIX.
- **Threads**: `pthread` support required.
- **IPv6**: Kernel must support IPv6 (dual-stack used).
