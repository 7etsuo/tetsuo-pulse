# Socket Library Cursor Rules (Comprehensive Ruleset)

This .cursorrules enforces CII/GNU standards + TLS1.3 hardening for production socket lib.
It consolidates all architectural, design, and implementation rules for the codebase.

## 0. Build System (CMake)

The project uses CMake with C11 standard:

```cmake
cmake_minimum_required(VERSION 3.10)
set(CMAKE_C_STANDARD 11)
set(CMAKE_C_STANDARD_REQUIRED ON)
set(CMAKE_C_EXTENSIONS ON)  # Enable GNU extensions (_GNU_SOURCE)
```

### Build Commands
```bash
mkdir build && cd build
cmake .. -DCMAKE_BUILD_TYPE=Debug
make          # Build libraries and tests
make test     # Run test suite
make doc      # Generate Doxygen documentation
```

### Compiler Flags
**ALWAYS** compile with strict warnings:
```cmake
set(CMAKE_C_FLAGS "-Wall -Wextra -Werror -D_GNU_SOURCE -pthread -fPIC")
```

### Optional Features
- TLS support: `-DENABLE_TLS=ON` (auto-detects OpenSSL/LibreSSL)
- Poll backend: Auto-selected per platform (epoll/kqueue/poll)
- Fuzzing: `-DENABLE_FUZZING=ON` (requires Clang, see Fuzzing section)
- Sanitizers: `-DENABLE_SANITIZERS=ON` (ASan + UBSan)

## 1. TLS1.3 Hardening (CRITICAL)
**ALWAYS** use the TLS1.3-only configuration defined in SocketTLSConfig.h:

```c
SSL_CTX_set_min_proto_version(ctx, SOCKET_TLS_MIN_VERSION);  /* TLS1.3 min */
SSL_CTX_set_max_proto_version(ctx, SOCKET_TLS_MAX_VERSION);  /* TLS1.3 max */
SSL_CTX_set_ciphersuites(ctx, SOCKET_TLS13_CIPHERSUITES);    /* Modern PFS suites */
```

**Rationale**: Eliminates legacy protocol/cipher vulnerabilities while enabling faster handshakes and forward secrecy.

## 2. Coding Style (GNU C11)

### Header Files
- **ALWAYS** use include guards with `_INCLUDED` suffix:
  ```c
  #ifndef FILENAME_INCLUDED
  #define FILENAME_INCLUDED
  ...
  #endif
  ```
- **ALWAYS** include module documentation at the top.

### Functions
- **ALWAYS** use Doxygen-style comments (`/** ... */`).
- **ALWAYS** put function return type on a separate line:
  ```c
  ReturnType
  FunctionName(Type1 param1, Type2 param2)
  {
      // Body
  }
  ```
- **ALWAYS** use `static` for private helper functions.

### Macros
- **ALWAYS** use `do { ... } while(0)` for complex macros.
- **ALWAYS** use ALL_CAPS for constants and macros.
- **ALWAYS** parenthesize macro arguments: `#define VALID(x) ((x) > 0)`.

## 3. Architecture & Design Patterns

### Layered Architecture
1. **Foundation**: `Arena` (Memory), `Except` (Errors).
2. **Utilities**: `SocketUtil` (Logging, Metrics, Events, Error Handling), `SocketTimer` (Timers), `SocketRateLimit` (Token Bucket).
3. **Base Abstraction**: `SocketCommon` (Shared base `SocketBase_T` for Socket/SocketDgram).
4. **Core I/O**: `Socket` (TCP/Unix), `SocketDgram` (UDP), `SocketBuf` (Buffers), `SocketIO` (I/O helpers).
   *   *Note*: `Socket.c` integrates core lifecycle, bind, accept, and state logic.
   *   *Split Files*: `Socket-connect.c`, `Socket-iov.c`, `Socket-options.c` contain specialized logic.
5. **DNS**: `SocketDNS` (Async DNS with worker threads).
6. **Event System**: `SocketPoll` (epoll/kqueue/poll abstraction), `SocketAsync` (Async I/O integration).
7. **Connection Helpers**: `SocketHappyEyeballs` (RFC 8305), `SocketReconnect` (Auto-reconnection with backoff).
8. **Security**: `SocketSYNProtect` (SYN flood protection), `SocketIPTracker` (Per-IP limits).
9. **Application**: `SocketPool` (Connection management).
10. **TLS**: `SocketTLS` (TLS I/O), `SocketTLSContext` (Context management).

### Resource Management
- **Acquisition Order**: Arena -> Server Socket -> Poll -> Timer -> Connection Pool -> Buffers.
- **Cleanup Order**: Reverse of acquisition.
- **ALWAYS** use `Arena` for memory management of related objects.

### Socket Base Delegation Pattern
- **ALWAYS** use `SocketBase_T` (opaque type in `SocketCommon.h`) for shared socket state:
  ```c
  /* SocketBase_T is opaque - use SocketCommon_new_base() to create */
  SocketBase_T base = SocketCommon_new_base(domain, type, protocol);
  /* Common fields: fd, arena, local/remote endpoints, timeouts, domain, type, protocol */
  ```
- **Shared Operations** via `SocketCommon_*` helpers:
  - `SocketCommon_set_option_int()` - Generic setsockopt wrapper
  - `SocketCommon_set_nonblock()` - Non-blocking mode
  - `SocketCommon_set_ttl()` - TTL/hop limit by family
  - `SocketCommon_join_multicast()` / `SocketCommon_leave_multicast()` - Multicast
  - `SocketCommon_calculate_total_iov_len()` - Safe iovec total with overflow check
  - `SocketCommon_advance_iov()` - Advance iovec for partial I/O
  - `SocketCommon_alloc_iov_copy()` - Allocate iovec copy for sendvall/recvvall
- Stream sockets (`Socket_T`) add TLS fields via composition when `SOCKET_HAS_TLS` defined.
- Datagram sockets (`SocketDgram_T`) use base directly (simpler, no TLS).

### Opaque Types
- **ALWAYS** use the `T` macro pattern for public opaque types:
  ```c
  #define T ModuleName_T
  typedef struct T *T;
  /* In .c file: struct T { ... }; */
  ```

## 4. Error Handling (Exceptions)

### Pattern
- **ALWAYS** use the `Except_T` system with `TRY`, `EXCEPT`, `FINALLY`, `END_TRY`.
- **NEVER** return error codes for fatal/exceptional conditions; raise exceptions.

### Thread Safety (CRITICAL)
- **ALWAYS** use thread-local storage for error buffers and exception copies.
- **NEVER** modify global exception structures directly.
- **Use Centralized Macros** from `SocketUtil.h`:
  ```c
  /* Declare thread-local exception (use once per module) */
  SOCKET_DECLARE_MODULE_EXCEPTION(ModuleName);
  
  /* Raise with detailed error message (uses socket_error_buf) */
  #define RAISE_MODULE_ERROR(e) SOCKET_RAISE_MODULE_ERROR(ModuleName, e)
  ```

### Error Formatting
- **Use** `SOCKET_ERROR_FMT(fmt, ...)` for errors with errno information.
- **Use** `SOCKET_ERROR_MSG(fmt, ...)` for errors without errno.
- Both macros auto-emit to logging and handle truncation.

### Unified Format-and-Raise Macros (Preferred)
- **Use** `SOCKET_RAISE_FMT(module, exc, fmt, ...)` - Format with errno AND raise in one step.
- **Use** `SOCKET_RAISE_MSG(module, exc, fmt, ...)` - Format message AND raise in one step.
  ```c
  /* Example: Combines SOCKET_ERROR_FMT + RAISE_MODULE_ERROR */
  if (bind(fd, addr, addrlen) < 0)
      SOCKET_RAISE_FMT(Socket, Socket_Failed, "bind to %s:%d failed", host, port);
  ```

### Safe System Calls
- **ALWAYS** use `SAFE_CLOSE(fd)` which handles `EINTR` correctly (per POSIX.1-2008, do NOT retry close on EINTR).

## 5. Memory Management

### Arenas
- **ALWAYS** use `Arena_alloc` / `Arena_calloc` for object lifecycle management.
- **ALWAYS** use `Arena_dispose` to free entire contexts.

### Safety
- **ALWAYS** check for integer overflow before allocation or buffer arithmetic.
- **ALWAYS** use `SocketBuf_secureclear` for sensitive data.
- **Alignment**: Use `union align` to ensure proper memory alignment.

## 6. Module Specific Rules

### Socket (TCP/Unix)
- **Split Implementation**: 
  - `Socket.c`: Core lifecycle (`new`, `free`), `bind`, `accept`, `listen`, state queries (`isconnected`, etc.), and Unix domain specifics.
  - `Socket-connect.c`: Connection logic.
  - `Socket-iov.c`: Scatter/gather I/O (`sendv`, `recvv`).
  - `Socket-options.c`: Socket option getters/setters.
- **DNS**: `Socket_bind`/`Socket_connect` may block on DNS. Use `SocketDNS` for non-blocking resolution.
- **Unix Domain**: Support `AF_UNIX`. Prefer absolute paths. Handle stale socket files (unlink before bind).
- **Lifecycle**: Use `Socket_new()`, `Socket_free()`. Track with `Socket_debug_live_count()`.

### SocketDgram (UDP)
- **Structure**: Contains `SocketBase_T base` only (simpler than Socket_T).
- **Connectionless**: No `listen`/`accept`.
- **Sizing**: Respect `UDP_MAX_PAYLOAD` (65507). Prefer `SAFE_UDP_SIZE` (1472) to avoid fragmentation.
- **Pattern**: Use `SocketDgram_recvfrom`/`SocketDgram_sendto`.

### SocketPoll (Events)
- **Edge Triggered**: Always use Edge Triggered mode (`EPOLLET`) where available.
- **Cross-Platform Backends** (auto-selected by CMake):
  - `SocketPoll_epoll.c` - Linux (epoll)
  - `SocketPoll_kqueue.c` - BSD/macOS (kqueue)
  - `SocketPoll_poll.c` - POSIX fallback (poll)
- **Data Map**: Hash table mapping `Socket` -> `User Data`.
- **Hash Function**: Golden ratio multiplicative hash (`HASH_GOLDEN_RATIO = 2654435761u`).
- **Default Timeout**: Use `SOCKET_POLL_TIMEOUT_USE_DEFAULT` (-2) to use poll's configured default.

### SocketDNS (Async)
- **Thread Pool**: Use worker threads for `getaddrinfo`.
- **Signaling**: Use pipe to signal completion to `SocketPoll`.
- **Ownership**: Caller owns `addrinfo` result and MUST call `freeaddrinfo`.
- **Timeout**: Propagate via `SocketDNS_request_settimeout()`.

### SocketTimer (Timers)
- **Min-Heap**: O(log n) insert/cancel, O(1) next-timer lookup.
- **Integration**: Callbacks fire during `SocketPoll_wait()`.
- **Monotonic Clock**: Uses `CLOCK_MONOTONIC`.

### SocketRateLimit (Token Bucket)
- **Algorithm**: Token bucket for connection rate and bandwidth limiting.
- **Thread-Safe**: All operations protected by internal mutex.
- **Non-Blocking**: `SocketRateLimit_try_acquire()` returns immediately.

### SocketHappyEyeballs (RFC 8305)
- **Dual-Stack Racing**: Races IPv6 and IPv4 connections for fastest result.
- **State Machine**: `IDLE -> RESOLVING -> CONNECTING -> CONNECTED | FAILED | CANCELLED`.
- **Async API**: `SocketHappyEyeballs_start()` / `_process()` / `_poll()` / `_result()` for event loops.

### SocketReconnect (Auto-Reconnection)
- **State Machine**: `DISCONNECTED -> CONNECTING -> CONNECTED -> BACKOFF -> CIRCUIT_OPEN`.
- **Backoff**: Configurable initial delay, max delay, multiplier, jitter.
- **Circuit Breaker**: Opens after consecutive failures.

### SocketTLS (TLS Operations)
- **TLS1.3 Only**: Strict modern security (see TLSConfig.h).
- **Non-Blocking**: `SocketTLS_handshake()` returns state for poll integration.
- **Exceptions**: `SocketTLS_Failed`, `SocketTLS_HandshakeFailed`, `SocketTLS_VerifyFailed`.

### SocketSYNProtect (SYN Flood Protection)
- **Purpose**: Prevent SYN flood DoS attacks by tracking connection attempts before accept().
- **Actions**: `SYN_ACTION_ALLOW`, `SYN_ACTION_THROTTLE`, `SYN_ACTION_CHALLENGE`, `SYN_ACTION_BLOCK`.
- **Reputation Scoring**: Adaptive 0.0-1.0 score with decay.
- **Kernel Integration**: `TCP_DEFER_ACCEPT` (Linux) / `SO_ACCEPTFILTER` (BSD).

### SocketAsync (Async I/O)
- **Backends**: io_uring (Linux 5.1+), kqueue AIO (BSD/macOS), edge-triggered fallback.
- **Integration**: Access via `SocketPoll_get_async()`.
- **Operations**: `SocketAsync_send()`, `SocketAsync_recv()`.

## 7. Fuzzing and Testing

### Fuzzing
- **Enable**: `cmake .. -DENABLE_FUZZING=ON -DCMAKE_BUILD_TYPE=Debug` (requires Clang).
- **Scripts**: Use `scripts/run_fuzz_parallel.sh` for massive parallel fuzzing.
- **Corpus**: Stored in `src/fuzz/corpus/`.
- **Targets**: 20+ harnesses covering core, socket, dns, and tls modules.

### Testing Rules
- **Sanitizers**: All tests MUST pass with AddressSanitizer (`ASan`) and UndefinedBehaviorSanitizer (`UBSan`).
- **Live Count**: Verify `Socket_debug_live_count() == 0` at end of tests.
- **Async Tests**: Do not wait indefinitely; verify API calls and use `SocketDNS_cancel` for cleanup.

## 8. Platform Requirements
- **Target**: Linux/POSIX (primary), BSD/macOS (supported).
- **C Standard**: C11 with GNU extensions (`_GNU_SOURCE`).
- **Poll Backends**: epoll (Linux), kqueue (BSD/macOS), poll (POSIX fallback).
- **TLS**: OpenSSL 1.1.1+ or LibreSSL.

## 9. State Machine Pattern

Several modules use explicit state machines for async operations:

```c
/* Example state enum pattern */
typedef enum
{
  STATE_IDLE = 0,      /* Not started */
  STATE_IN_PROGRESS,   /* Operation running */
  STATE_COMPLETE,      /* Success - call result() */
  STATE_FAILED,        /* Error - call error() */
  STATE_CANCELLED      /* User cancelled */
} ModuleState;
```

**Modules Using State Machines:**
- `SocketHappyEyeballs`
- `SocketReconnect`
- `SocketTLS`
- `SocketSYNProtect`

## 10. Callback Pattern

Several modules use callbacks for extensibility:

```c
/* Callback function type pattern */
typedef void (*ModuleCallback)(T context, EventType event, void *userdata);

/* Registration */
Module_set_callback(T ctx, ModuleCallback cb, void *userdata);
```

**Modules Using Callbacks:**
- `SocketTimer`
- `SocketReconnect`
- `SocketLog`
- `SocketEvent`
- `SocketAsync`

**Callback Safety Rules:**
- **NEVER** call `Module_free()` from within its own callback.
- Callbacks execute in the thread that calls `process()` or `SocketPoll_wait()`.

## 11. Bandwidth Limiting

Sockets support bandwidth throttling via token bucket:

```c
/* Enable bandwidth limiting on a socket */
Socket_setbandwidth(socket, bytes_per_sec);  /* 0 = unlimited */

/* Use rate-limited I/O */
ssize_t n = Socket_send_limited(socket, buf, len);
if (n == 0) {
    /* Rate limited - wait before retry */
    int64_t wait = Socket_bandwidth_wait_ms(socket, len);
}
```

## 12. Debugging Patterns

### Live Socket Count Tracking
Use `SocketLiveCount` for leak detection in tests:

```c
/* Usage in modules */
static struct SocketLiveCount socket_live_count = SOCKETLIVECOUNT_STATIC_INIT;

/* In Socket_new(): */
SocketLiveCount_increment(&socket_live_count);

/* In Socket_free(): */
SocketLiveCount_decrement(&socket_live_count);

/* Query for tests: */
int Socket_debug_live_count(void);
```

## 13. Hash Utilities

Centralized hash functions in `SocketUtil.h`:

```c
/* Hash file descriptor (for socket lookups) */
unsigned socket_util_hash_fd(int fd, unsigned table_size);

/* Hash pointer (for opaque handle lookups) */
unsigned socket_util_hash_ptr(const void *ptr, unsigned table_size);
```

**Golden Ratio Constant**: `HASH_GOLDEN_RATIO = 2654435761u` (2^32 * (sqrt(5)-1)/2)
